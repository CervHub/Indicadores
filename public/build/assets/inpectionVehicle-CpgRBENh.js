import{U as S,j as e,m as je,r as U,S as Ne}from"./app-CDXy3SBE.js";import{B as H}from"./button-BWENKPYs.js";import{I as g}from"./input-BU5rwtW1.js";import{L as E}from"./label-CtGGAro0.js";import{S as ie,a as oe,b as le,c as ce,f as q}from"./select-BQ4LeIfa.js";import{t as O}from"./index-BXJU_opb.js";import{I as ve}from"./image-BGlyGo0x.js";import{C as ye,V as _e}from"./utils-CISCwvQU.js";import{T as we,a as Ce,b as W,c as k,d as De,e as V}from"./table-BvBg9NC5.js";import{D as te,a as Se,b as se,c as ae,d as re}from"./dialog-B-5PyXvn.js";import{D as G}from"./download-CjEPRtnE.js";import{F as Z}from"./app-layout-BtW-4z9d.js";import{I as ne}from"./info-DB07EsIb.js";import{T as Fe}from"./triangle-alert-BN4AAWo4.js";import{S as Te}from"./search-CHZs1gD0.js";function Ee(h){const[v,f]=S.useState(h.map(x=>({id:x.id,name:x.name,state:"",observation:""}))),[w,y]=S.useState({}),[L,p]=S.useState(!1),[P,A]=S.useState([]),[M,s]=S.useState(""),[i,l]=S.useState(null);return{causaStates:v,setCausaStates:f,extraFormData:w,setExtraFormData:y,modalOpen:L,setModalOpen:p,modalAttributes:P,setModalAttributes:A,modalTitle:M,setModalTitle:s,modalCausaId:i,setModalCausaId:l}}const Ie=[{value:"4",label:"4",img:"/images/neumaticos/01.png"},{value:"6",label:"6",img:"/images/neumaticos/02.png"},{value:"10",label:"10",img:"/images/neumaticos/03.png"},{value:"12",label:"12",img:"/images/neumaticos/04.png"},{value:"14",label:"14",img:"/images/neumaticos/05.png"}];function Oe({attributes:h,causaId:v,extraFormData:f,setExtraFormData:w,causaState:y}){const L=f[v]||{};function p(s){if(!s)return"";const i=ye.find(l=>l.value===s);return i?i.label:s}function P(s,i){let l=!1,x="";if(s.attribute_type==="fecha"&&s.min_value!==null&&s.min_value!==void 0){if(s.min_value==="0"){if(x="Debe ser mayor o igual a hoy",i){const u=new Date;u.setHours(0,0,0,0);const F=new Date(i);F.setHours(0,0,0,0),l=F>=u}}else if(!isNaN(Number(s.min_value))&&(x=`Debe ser al menos dentro de ${s.min_value} días`,i)){const u=new Date;u.setHours(0,0,0,0);const F=new Date(u);F.setDate(u.getDate()+Number(s.min_value));const r=new Date(i);r.setHours(0,0,0,0),l=r>=F}}else s.attribute_type==="entero"&&s.min_value!==null&&s.min_value!==void 0?(x=`Debe ser mayor o igual a ${s.min_value}`,i!==void 0&&i!==""&&!isNaN(Number(i))&&(l=Number(i)>=Number(s.min_value))):(s.attribute_type,x="Debe estar lleno",l=!!i&&i!=="");return{cumple:l,regla:x}}const A=(s,i,l,x)=>{const{cumple:u,regla:F}=P(x,i);w(r=>({...r,[v]:{...r[v],[s]:i,[`${s}_nombre`]:l,[`${s}_cumple`]:u,[`${s}_regla`]:F,[`${s}_conforme`]:u?"Conforme":"No Conforme"}}))};let M;if(y!=null&&y.name){const s=y.name.match(/^Neum[aá]ticos\s+(\d+)/i);if(s){const i=s[1],l=Ie.find(x=>x.value===i);M=l==null?void 0:l.img}}return e.jsxs("div",{className:"w-full",children:[e.jsx("form",{className:`
                    grid grid-cols-1 gap-4
                    sm:grid-cols-2
                    md:grid-cols-2
                    w-full
                `,children:h.map(s=>{const i=L[s.id];return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(E,{children:[s.name,s.unit&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["(",p(s.unit),")"]})]}),s.attribute_type==="fecha"&&e.jsx(g,{type:"date",value:i||"",onChange:l=>A(s.id,l.target.value,s.name,s)}),s.attribute_type==="entero"&&e.jsx(g,{type:"number",value:i||"",onChange:l=>A(s.id,l.target.value,s.name,s)}),s.attribute_type==="texto"&&e.jsx(g,{type:"text",value:i||"",onChange:l=>A(s.id,l.target.value,s.name,s)}),L[`${s.id}_regla`]&&e.jsxs("span",{className:"text-xs mt-1",children:["Estado: ",L[`${s.id}_conforme`]||""]})]},s.id)})}),M&&e.jsxs("div",{className:"w-full flex flex-col items-center mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground mb-2",children:"Referencia de neumáticos"}),e.jsx("img",{src:M,alt:"Referencia neumáticos",className:"max-w-xs max-h-92 "})]})]})}function Le({causas:h,causaStates:v,setCausaStates:f,extraFormData:w,setExtraFormData:y,groupedCausas:L,modalOpen:p,setModalOpen:P,modalAttributes:A,setModalAttributes:M,modalTitle:s,setModalTitle:i,modalCausaId:l,setModalCausaId:x}){const u=r=>{const c=v.find(T=>T.id===r.id),o=(c==null?void 0:c.observation)||"",j=T=>I(r.id,void 0,T.target.value);function I(T,m,_){const $=v.map(R=>R.id===T?{...R,state:R.state,observation:_}:R);f($)}switch(r.attribute_type){case"fecha":return e.jsx(g,{type:"date",value:o,onChange:j});case"entero":return e.jsx(g,{type:"number",value:o,onChange:j});case"texto":default:return e.jsx(g,{type:"text",value:o,onChange:j})}},F=r=>{if(!r.has_attributes||!r.category_attributes)return!0;const c=w[r.id]||{};return r.category_attributes.every(o=>!!c[o.id])};return S.useEffect(()=>{f(r=>r.map(c=>{const o=h.find(m=>m.id===c.id);if(!o||!o.has_attributes||!o.category_attributes)return c;const j=w[o.id]||{};if(o.category_attributes.map(m=>{const _=j[m.id];let $=!1;if(m.attribute_type==="fecha"&&m.min_value!==null){if(_)if(m.min_value==="0"){const R=new Date;R.setHours(0,0,0,0);const z=new Date(_);z.setHours(0,0,0,0),$=z>=R}else $=!0}else m.attribute_type==="entero"&&m.min_value!==null?_!==void 0&&_!==""&&!isNaN(Number(_))&&($=Number(_)>=Number(m.min_value)):(m.attribute_type,$=!!_&&_!=="");return{attrId:m.id,cumple:$}}).every(m=>m.cumple)){if(c.state!=="Conforme")return{...c,state:"Conforme"}}else if(c.state!=="No Conforme")return{...c,state:"No Conforme"};return c}))},[w,h,f]),e.jsxs(e.Fragment,{children:[e.jsxs(we,{children:[e.jsx(Ce,{children:e.jsxs(W,{className:"bg-muted/50 border-b",children:[e.jsx(k,{className:"border-r text-center"}),e.jsx(k,{className:"border-r text-center",children:e.jsx(G,{className:"w-4 h-4 mx-auto"})}),e.jsx(k,{className:"border-r text-center sm:min-w-[400px] md:min-w-[400px] lg:min-w-[400px] xl:min-w-[800px]",children:"Causa"}),e.jsx(k,{className:"border-r text-center",children:e.jsx(Z,{className:"w-4 h-4 mx-auto"})}),e.jsx(k,{className:"border-r text-center",children:"Estado"}),e.jsx(k,{className:"text-center w-[50px] md:min-w-[50px]",children:"Observaciones"})]})}),e.jsx(De,{children:Object.entries(L).map(([r,c])=>e.jsxs(S.Fragment,{children:[e.jsx(W,{className:"bg-muted/50",children:e.jsx(V,{colSpan:6,className:"text-center font-bold border-b",children:r})}),c.map(o=>{var j;return e.jsxs(W,{className:"border-b",children:[e.jsx(V,{className:"border-r text-center",children:o.instruction?e.jsxs(te,{children:[e.jsx(Se,{asChild:!0,children:e.jsx(H,{type:"button",size:"icon",variant:"outline",className:"mx-0",children:e.jsx(ne,{className:"w-3 h-5"})})}),e.jsxs(se,{children:[e.jsx(ae,{children:e.jsx(re,{children:"Instrucción"})}),e.jsx("div",{className:"whitespace-pre-line",children:o.instruction})]})]}):e.jsx(H,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(ne,{className:"w-5 h-5"})})}),e.jsx(V,{className:"border-r text-center",children:o.document_url?e.jsx("a",{href:`/${o.document_url}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center text-blue-600",download:o.document_name||void 0,title:o.document_name||"Descargar",children:e.jsx(H,{type:"button",size:"icon",variant:"outline",className:"mx-auto",children:e.jsx(G,{className:"w-5 h-5"})})}):e.jsx(H,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(G,{className:"w-5 h-5"})})}),e.jsx(V,{className:"border-r font-medium whitespace-normal",children:o.nombre||o.name}),e.jsx(V,{className:"border-r text-center p-0 align-middle",children:o.has_attributes?e.jsxs(H,{type:"button",size:"icon",variant:"ghost",className:"mx-auto p-0 h-8 w-8 relative",onClick:()=>{M(o.category_attributes||[]),i(o.nombre||o.name||""),x(o.id),P(!0)},children:[e.jsx(Z,{className:"w-4 h-4"}),!F(o)&&e.jsx("span",{className:"absolute top-0 right-0 flex items-center animate-pulse",children:e.jsx(Fe,{className:"w-4 h-4 text-yellow-900 drop-shadow-[0_0_4px_rgba(255,193,7,0.8)]"})})]}):e.jsx(H,{type:"button",size:"icon",variant:"ghost",disabled:!0,className:"mx-auto opacity-50 p-0 h-8 w-8",children:e.jsx(Z,{className:"w-4 h-4"})})}),e.jsx(V,{className:"border-r text-center",children:e.jsxs(ie,{value:((j=v.find(I=>I.id===o.id))==null?void 0:j.state)||"",onValueChange:I=>f(T=>T.map(m=>m.id===o.id?{...m,state:I}:m)),children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione"})}),e.jsxs(ce,{children:[e.jsx(q,{value:"Conforme",children:"Conforme"}),e.jsx(q,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(V,{children:u(o)})]},o.id)})]},r))})]}),e.jsx(te,{open:p,onOpenChange:r=>{P(r),r||x(null)},children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsx(re,{children:s})}),l&&e.jsx(Oe,{attributes:A,causaId:l,extraFormData:w,setExtraFormData:y,causaState:v.find(r=>r.id===l)})]})})]})}function $e(){const v=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),f=w=>{var y;return(y=v.find(L=>L.type===w))==null?void 0:y.value};return`${f("year")}-${f("month")}-${f("day")}T${f("hour")}:${f("minute")}`}function Qe({causas:h,type:v,userId:f,companyId:w,userName:y,company:L,area:p}){const P=h.filter(a=>{var t;return!((t=a.name)!=null&&t.toLowerCase().startsWith("neumáticos"))&&!a.is_crane}),A=h.filter(a=>{var t;return(t=a.name)==null?void 0:t.toLowerCase().startsWith("neumáticos")}),M=h.filter(a=>a.is_crane===!0),s=h.filter(a=>a.is_for_mine===!0),i=h.filter(a=>a.is_not_for_mine===!0),l=P.filter(a=>!a.is_for_mine&&!a.is_not_for_mine),x=[...l,...(p==null?void 0:p.toLowerCase())==="mina"?s:i],[u,F]=S.useState(x);S.useEffect(()=>{const a=[...l,...(p==null?void 0:p.toLowerCase())==="mina"?s:i];F(a)},[p,h]);const{data:r,setData:c,reset:o}=je({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",mileage:"",company:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:$e(),companyId:w,userId:f,userName:y,type_report:"vehicular",type_inspection:v,causas:x.map(a=>({id:a.id,name:a.name,state:"",observation:""})),status:"",area:p}),{causaStates:j,setCausaStates:I,extraFormData:T,setExtraFormData:m,modalOpen:_,setModalOpen:$,modalAttributes:R,setModalAttributes:z,modalTitle:me,setModalTitle:de,modalCausaId:ue,setModalCausaId:pe}=Ee(u);S.useEffect(()=>{I(a=>u.map(n=>{const d=a.find(N=>N.id===n.id);return d||{id:n.id,name:n.name,state:"",observation:""}})),m(a=>{const t={...a};return u.forEach(n=>{n.id in t||(t[n.id]={})}),Object.keys(t).forEach(n=>{u.some(d=>String(d.id)===String(n))||delete t[n]}),t})},[u,I,m]),S.useEffect(()=>{c(a=>({...a,area:p}))},[p]);const[J,K]=U.useState(!1),[Ae,Me]=U.useState(!1),[Y,Q]=U.useState(!1),B=()=>j.some(a=>a.state==="No Conforme")?"Desaprobado":j.every(a=>a.state)?"Aprobado":"";S.useEffect(()=>{c("result",B()),c("status",B())},[j]);const X=()=>{const a=u.every(t=>{if(!t.has_attributes||!t.category_attributes)return!0;const n=T[t.id]||{};return t.category_attributes.every(d=>!!n[d.id])});return r.plate&&r.type&&r.brand&&r.model&&r.engineNumber&&r.year&&r.company&&B()&&j.every(t=>t.state)&&a},xe=async()=>{if(!r.plate){O.error("Por favor, ingrese una placa para buscar.");return}K(!0),O.info("Buscando información para la placa...",{duration:3e3});try{const a=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:r.plate,company_id:w})),t=await a.json();if(a.ok&&t.status==="success"&&t.data){c(b=>({...b,vehicleCode:t.company.code+"-"+t.data.code||"",type:t.data.type||"",brand:t.data.brand||"",model:t.data.model||"",engineNumber:t.data.engine_number||"",year:t.data.year||"",company:t.company.nombre||""}));let n=[...l,...(p==null?void 0:p.toLowerCase())==="mina"?s:i];const d=t.data.tire_count;if(d){const b=`Neumáticos ${Number(d)}`,C=A.find(D=>D.name===b);C&&!n.some(D=>D.id===C.id)&&(n=[...n,C])}const N=(t.data.type||"").toLowerCase();(N.includes("grúa")||N.includes("grua"))&&M.forEach(b=>{n.some(C=>C.id===b.id)||n.push(b)}),F(n),O.success("Información del vehículo cargada con éxito.")}else t.status==="warning"?(O.warning(t.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),c(n=>({...n,vehicleCode:""}))):t.status==="error"?(O.error(t.message||"No se encontró información para la placa ingresada."),c(n=>({...n,vehicleCode:""}))):(O.error("No se encontró información para la placa ingresada."),c(n=>({...n,vehicleCode:""})))}catch(a){console.error(a),O.error("Ocurrió un error al buscar la placa."),c(t=>({...t,vehicleCode:""}))}finally{K(!1)}},he=async a=>{if(a.preventDefault(),!X()){O.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}Q(!0);try{const t=j.map(d=>{const N=T[d.id]||{};let b=[];const C=h.find(D=>D.id===d.id);return C&&C.category_attributes&&(b=C.category_attributes.map(D=>({id:D.id,value:N[D.id]??"",name:D.name,status:N[`${D.id}_cumple`]===!0}))),{...d,extraForm:b}}),n=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,causas:t,status:B()})});if(n.ok){const d=await n.json();O.success(d.message||"Reporte guardado con éxito."),o(),I(h.map(N=>({id:N.id,state:"",observation:""}))),Ne.visit(route("admin.reportability"))}else if(n.status===422){const d=await n.json();O.error("Errores de validación en el formulario."),console.error(d.errors)}else throw new Error("Error al guardar el reporte.")}catch(t){console.error(t),O.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{Q(!1)}},fe=u.reduce((a,t)=>(a[t.group]||(a[t.group]=[]),a[t.group].push(t),a),{});return e.jsx(e.Fragment,{children:e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:he,children:[e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(g,{type:"text",id:"plate",value:r.plate||"",onChange:a=>c("plate",a.target.value),className:"flex-1"}),e.jsx(H,{variant:"outline",type:"button",onClick:xe,className:"flex items-center px-2",disabled:J,children:J?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(Te,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(g,{type:"text",id:"vehicleCode",value:r.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(ie,{value:r.type,disabled:!0,children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione un tipo"})}),e.jsx(ce,{children:_e.map(({value:a,label:t})=>e.jsx(q,{value:a,children:t},a))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(g,{type:"text",id:"brand",value:r.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(g,{type:"text",id:"model",value:r.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(g,{type:"text",id:"engineNumber",value:r.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(g,{type:"text",id:"year",value:r.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(g,{type:"text",id:"company",value:r.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(E,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(g,{type:"number",id:"mileage",value:r.mileage||"",onChange:a=>{const t=a.target.value.replace(/\D/g,"").slice(0,7);c("mileage",t)},min:0,max:9999999,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsx(Le,{causas:u,causaStates:j,setCausaStates:I,extraFormData:T,setExtraFormData:m,groupedCausas:fe,modalOpen:_,setModalOpen:$,modalAttributes:R,setModalAttributes:z,modalTitle:me,setModalTitle:de,modalCausaId:ue,setModalCausaId:pe})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(ve,{images:r.images,onUpload:a=>{a.forEach(t=>{const n=new FileReader;n.onload=()=>{const d=n.result,N=new Image;N.src=d,N.onload=()=>{const b=document.createElement("canvas"),C=b.getContext("2d"),D=800,be=D/N.width;b.width=D,b.height=N.height*be,C==null||C.drawImage(N,0,0,b.width,b.height);const ge=b.toDataURL("image/jpeg",.8);c(ee=>({...ee,images:[...ee.images,ge].slice(0,4)}))}},n.readAsDataURL(t)})},onRemove:a=>{const t=r.images.filter((n,d)=>d!==a);c(n=>({...n,images:t}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(E,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(g,{type:"text",id:"inspectedBy",value:y,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(E,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(g,{type:"text",id:"result",value:B(),disabled:!0,className:B()==="Desaprobado"?"text-red-600 font-bold":B()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(H,{type:"submit",className:"flex items-center",disabled:!X()||Y,children:Y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})})}export{Qe as I};
