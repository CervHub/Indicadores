import{r as g,U as j,j as e,S as _}from"./app-CkX-sCCf.js";import{B as I}from"./button-Bw2Xdp6E.js";import{I as p}from"./input-MjwaqtbJ.js";import{L as d}from"./label-B68sH3c7.js";import{S as k,a as A,b as B,c as R,f as F}from"./select-DPNjP_Lz.js";import{T as H,a as q,b as P,c as D,d as U,e as V}from"./table-DskUy7h3.js";import{T as G}from"./textarea-C-cigTeO.js";import{t as n}from"./index-uPTyyJTB.js";import{S as J}from"./search-fTzzglXd.js";function N(){const b=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(new Date),i=h=>{var m;return(m=b.find(f=>f.type===h))==null?void 0:m.value};return`${i("year")}-${i("month")}-${i("day")}T${i("hour")}:${i("minute")}:${i("second")}`}function ae({causas:u,companyId:b,userId:i,userName:h,area:m,isVisita:f=!1}){const[r,o]=g.useState({plate:"",vehicleCode:"",department:"",shift:N(),driver:h,mileage:"",images:[],signature:"",observation:"",causas:u.map(s=>({id:s.id,state:""})),companyId:b,userId:i,userName:h,type_report:"vehicular",type_inspection:f?"pre-use-visit":"pre-use",status:"",area:m});j.useEffect(()=>{o(s=>({...s,area:m}))},[m]),j.useEffect(()=>{o(s=>({...s,type_inspection:f?"pre-use-visit":"pre-use"}))},[f]);const[y,C]=g.useState(!1),[l,S]=g.useState({}),[w,T]=g.useState(!1),E=()=>{const s=r.causas.every(a=>a.state!=="");return r.plate&&r.vehicleCode&&r.department&&r.shift&&r.mileage&&s},$=(s,a)=>{const t=u.find(c=>c.id===s);o(c=>({...c,causas:c.causas.map(v=>v.id===s?{...v,state:a,item:(t==null?void 0:t.name)||""}:v)}))},L=async()=>{if(!r.plate){n.error("Por favor, ingrese una placa para buscar.");return}T(!0),n.info("Buscando información para la placa...",{duration:3e3});try{const s=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:r.plate,company_id:b})),a=await s.json();s.ok&&a.status==="success"&&a.data?(o(t=>({...t,vehicleCode:a.company.code+"-"+a.data.code||"",department:a.company.nombre||""})),n.success("Información del vehículo cargada con éxito.")):a.status==="warning"?(n.warning(a.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),o(t=>({...t,vehicleCode:""}))):a.status==="error"?(n.error(a.message||"No se encontró información para la placa ingresada."),o(t=>({...t,vehicleCode:""}))):(n.error("No se encontró información para la placa ingresada."),o(t=>({...t,vehicleCode:""})))}catch(s){console.error(s),n.error("Ocurrió un error al buscar la placa."),o(a=>({...a,vehicleCode:""}))}finally{T(!1)}},x=()=>r.causas.every(a=>a.state!=="")?r.causas.some(a=>a.state==="No Conforme")?"Desaprobado":"Aprobado":"";j.useEffect(()=>{const s=x();o(a=>({...a,status:s}))},[r.causas]),j.useEffect(()=>{const s=setInterval(()=>{o(a=>({...a,shift:N()}))},1e3);return()=>clearInterval(s)},[]);const O=async s=>{if(s.preventDefault(),!E()){n.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}C(!0),S({});try{const a=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,status:x()})});if(!a.ok){if(a.status===422){const c=await a.json();S(c.errors||{})}throw new Error("Error al enviar el formulario.")}const t=await a.json();n.success(t.message||"Reporte generado con éxito."),_.visit(route("admin.reportability")),o(c=>({...c,plate:"",vehicleCode:"",department:"",shift:N(),driver:h,mileage:"",images:[],signature:"",observation:"",causas:u.map(v=>({id:v.id,state:""}))}))}catch(a){console.error(a),n.error("Ocurrió un error al enviar el formulario. Intente de nuevo.")}finally{C(!1)}};return e.jsxs("form",{className:"grid grid-cols-4 gap-6 md:grid-cols-4 lg:grid-cols-5",onSubmit:O,children:[e.jsxs("div",{className:"col-span-4 flex items-end gap-2 md:col-span-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(d,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsx(p,{type:"text",id:"plate",value:r.plate,onChange:s=>o(a=>({...a,plate:s.target.value}))}),l.plate&&e.jsx("p",{className:"text-sm text-red-500",children:l.plate})]}),e.jsx(I,{type:"button",variant:"outline",onClick:L,className:"mt-6 h-10",disabled:w,children:w?e.jsx("span",{className:"loader h-4 w-4 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(J,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(d,{htmlFor:"vehicle-code",className:"mb-3",children:"Código de Llamada"}),e.jsx(p,{disabled:!0,type:"text",id:"vehicle-code",value:r.vehicleCode,onChange:s=>o(a=>({...a,vehicleCode:s.target.value}))}),l.vehicleCode&&e.jsx("p",{className:"text-sm text-red-500",children:l.vehicleCode})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(d,{htmlFor:"department",className:"mb-3",children:"Empresa"}),e.jsx(p,{disabled:!0,type:"text",id:"department",value:r.department,onChange:s=>o(a=>({...a,department:s.target.value}))}),l.department&&e.jsx("p",{className:"text-sm text-red-500",children:l.department})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(d,{htmlFor:"shift",className:"mb-3",children:"Hora actual"}),e.jsx(p,{id:"shift",type:"datetime-local",value:r.shift,disabled:!0})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(d,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(p,{type:"number",id:"mileage",value:r.mileage,onChange:s=>o(a=>({...a,mileage:s.target.value}))}),l.mileage&&e.jsx("p",{className:"text-sm text-red-500",children:l.mileage})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background rounded-md border",children:e.jsxs(H,{children:[e.jsx(q,{children:e.jsxs(P,{className:"bg-muted/50 border-b",children:[e.jsx(D,{className:"h-9 w-9/10 border-r py-2",children:"Item"}),e.jsx(D,{className:"h-9 w-1/10 py-2",children:"Estado"})]})}),e.jsx(U,{children:u.map(s=>{var a;return e.jsxs(P,{children:[e.jsx(V,{className:"border-r py-2 font-medium whitespace-normal",children:s.name}),e.jsx(V,{className:"text-center",children:e.jsxs(k,{value:((a=r.causas.find(t=>t.id===s.id))==null?void 0:a.state)||"",onValueChange:t=>$(s.id,t),children:[e.jsx(A,{children:e.jsx(B,{placeholder:"Seleccione estado"})}),e.jsxs(R,{children:[e.jsx(F,{value:"Conforme",children:"Conforme"}),e.jsx(F,{value:"No Conforme",children:"No Conforme"})]})]})})]},s.id)})})]})})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx(d,{htmlFor:"observation",className:"mb-3",children:"Observaciones"}),e.jsx(G,{id:"observation",value:r.observation,onChange:s=>o(a=>({...a,observation:s.target.value})),placeholder:"Escriba sus observaciones aquí..."}),l.observation&&e.jsx("p",{className:"text-sm text-red-500",children:l.observation})]}),e.jsxs("div",{className:"col-span-auto",children:[e.jsx(d,{htmlFor:"status",className:"mb-3",children:"Estado final"}),e.jsx(p,{id:"status",value:x(),disabled:!0,className:x()==="Desaprobado"?"text-red-600 font-bold":x()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("br",{}),e.jsx("div",{className:"col-span-4",children:e.jsx(I,{type:"submit",className:"flex-start",disabled:!E()||y,children:y?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):"Generar reporte"})})]})}export{ae as I};
