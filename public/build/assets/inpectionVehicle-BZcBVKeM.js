import{m as V,r as w,U as k,j as e}from"./app-DFJY1BGy.js";import{B as L}from"./button-Bc6R-Kxb.js";import{I as m}from"./input-BWsNATuj.js";import{L as p}from"./label-BLQodZug.js";import{S as G,a as H,b as Z,c as q,f as z}from"./select-nimDZlVg.js";import{T as J,a as W,b as S,c as b,d as K,e as g}from"./table-KHlJsidM.js";import{t as o}from"./index-BFxsZ1xd.js";import{I as Q}from"./image-BFaXab-W.js";import{S as X}from"./search-BuwFjt7W.js";function Y(){const C=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),u=v=>{var f;return(f=C.find(I=>I.type===v))==null?void 0:f.value};return`${u("year")}-${u("month")}-${u("day")}T${u("hour")}:${u("minute")}`}const ee={camioneta:"Camioneta",combi:"Combi",ambulancia:"Ambulancia",bus:"Bus",camión:"Camión","camión grúa":"Camión Grúa",otros:"Otros"};function pe({causas:j,type:C,userId:u,companyId:v,userName:f,company:I}){const{data:t,setData:d,reset:M}=V({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",company:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:Y(),companyId:v,userId:u,userName:f,type_report:"vehicular",type_inspection:C,causas:j.map(r=>({id:r.id,state:"",observation:""}))}),[c,F]=w.useState(j.map(r=>({id:r.id,state:"",observation:""}))),[T,D]=w.useState(!1),[ae,se]=w.useState(!1),[A,B]=w.useState(!1),y=()=>c.some(r=>r.state==="Mal")?"Desaprobado":c.every(r=>r.state)?"Aprobado":"";k.useEffect(()=>{d("result",y())},[c]);const E=()=>t.plate&&t.type&&t.brand&&t.model&&t.engineNumber&&t.year&&t.company&&y()&&c.every(r=>r.state),N=(r,a,s)=>{const i=c.map(n=>n.id===r?{...n,state:a||n.state,observation:s}:n);F(i),d("causas",i)},O=async()=>{if(!t.plate){o.error("Por favor, ingrese una placa para buscar.");return}D(!0),o.info("Buscando información para la placa...",{duration:3e3});try{const r=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:t.plate,company_id:v})),a=await r.json();r.ok&&a.status==="success"&&a.data?(d(s=>({...s,vehicleCode:a.data.code||"",type:a.data.type||"",brand:a.data.brand||"",model:a.data.model||"",engineNumber:a.data.engine_number||"",year:a.data.year||"",company:a.company.nombre||""})),o.success("Información del vehículo cargada con éxito.")):a.status==="warning"?(o.warning(a.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),d(s=>({...s,vehicleCode:""}))):a.status==="error"?(o.error(a.message||"No se encontró información para la placa ingresada."),d(s=>({...s,vehicleCode:""}))):(o.error("No se encontró información para la placa ingresada."),d(s=>({...s,vehicleCode:""})))}catch(r){console.error(r),o.error("Ocurrió un error al buscar la placa."),d(a=>({...a,vehicleCode:""}))}finally{D(!1)}},P=async r=>{if(r.preventDefault(),!E()){o.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}B(!0);try{const a=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,causas:c})});if(a.ok){const s=await a.json();o.success(s.message||"Reporte guardado con éxito."),M(),F(j.map(i=>({id:i.id,state:"",observation:""})))}else if(a.status===422){const s=await a.json();o.error("Errores de validación en el formulario."),console.error(s.errors)}else throw new Error("Error al guardar el reporte.")}catch(a){console.error(a),o.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{B(!1)}},$=j.reduce((r,a)=>(r[a.group]||(r[a.group]=[]),r[a.group].push(a),r),{});return e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:P,children:[e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(m,{type:"text",id:"plate",value:t.plate||"",onChange:r=>d("plate",r.target.value),className:"flex-1"}),e.jsx(L,{variant:"outline",type:"button",onClick:O,className:"flex items-center px-2",disabled:T,children:T?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(X,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(m,{type:"text",id:"vehicleCode",value:t.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(G,{value:t.type,disabled:!0,children:[e.jsx(H,{className:"w-full",children:e.jsx(Z,{placeholder:"Seleccione un tipo"})}),e.jsx(q,{children:Object.entries(ee).map(([r,a])=>e.jsx(z,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(m,{type:"text",id:"brand",value:t.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(m,{type:"text",id:"model",value:t.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(m,{type:"text",id:"engineNumber",value:t.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(m,{type:"text",id:"year",value:t.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(p,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(m,{type:"text",id:"company",value:t.company||"",disabled:!0})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsxs(J,{children:[e.jsxs(W,{children:[e.jsxs(S,{className:"bg-muted/50 border-b",children:[e.jsx(b,{className:"h-8 border-r py-2",rowSpan:2,style:{width:"50%"},children:"Item"}),e.jsx(b,{className:"h-8 border-r py-2",colSpan:3,children:"Estado"}),e.jsx(b,{className:"h-8 border-l py-2",rowSpan:2,style:{width:"20%"},children:"Observaciones"})]}),e.jsxs(S,{className:"bg-muted/50 border-b",children:[e.jsx(b,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Bien"}),e.jsx(b,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Mal"}),e.jsx(b,{className:"h-8 py-2",style:{width:"10%"},children:"No Aplica"})]})]}),e.jsx(K,{children:Object.entries($).map(([r,a])=>e.jsxs(k.Fragment,{children:[e.jsx(S,{className:"bg-muted/50",children:e.jsx(g,{colSpan:5,className:"text-center font-bold",children:r})}),a.map(s=>{var i,n,h,x;return e.jsxs(S,{children:[e.jsx(g,{className:"border-r py-1 font-medium whitespace-normal",children:s.name}),e.jsx(g,{className:"text-center",children:e.jsx("label",{className:"inline-flex items-center cursor-pointer",children:e.jsx("input",{type:"radio",name:`estado-${s.id}`,value:"Bien",checked:((i=c.find(l=>l.id===s.id))==null?void 0:i.state)==="Bien",onChange:()=>N(s.id,"Bien",""),className:"w-6 h-6 accent-green-600 cursor-pointer"})})}),e.jsx(g,{className:"border-r border-l text-center",children:e.jsx("label",{className:"inline-flex items-center cursor-pointer",children:e.jsx("input",{type:"radio",name:`estado-${s.id}`,value:"Mal",checked:((n=c.find(l=>l.id===s.id))==null?void 0:n.state)==="Mal",onChange:()=>N(s.id,"Mal",""),className:"w-6 h-6 accent-red-500 cursor-pointer"})})}),e.jsx(g,{className:"text-center",children:e.jsx("label",{className:"inline-flex items-center cursor-pointer",children:e.jsx("input",{type:"radio",name:`estado-${s.id}`,value:"No Aplica",checked:((h=c.find(l=>l.id===s.id))==null?void 0:h.state)==="No Aplica",onChange:()=>N(s.id,"No Aplica",""),className:"w-6 h-6 accent-gray-600 cursor-pointer"})})}),e.jsx(g,{children:e.jsx(m,{type:"text",value:((x=c.find(l=>l.id===s.id))==null?void 0:x.observation)||"",onChange:l=>N(s.id,"",l.target.value)})})]},s.id)})]},r))})]})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(Q,{images:t.images,onUpload:r=>{r.forEach(a=>{const s=new FileReader;s.onload=()=>{const i=s.result,n=new Image;n.src=i,n.onload=()=>{const h=document.createElement("canvas"),x=h.getContext("2d"),l=800,_=l/n.width;h.width=l,h.height=n.height*_,x==null||x.drawImage(n,0,0,h.width,h.height);const U=h.toDataURL("image/jpeg",.8);d(R=>({...R,images:[...R.images,U].slice(0,4)}))}},s.readAsDataURL(a)})},onRemove:r=>{const a=t.images.filter((s,i)=>i!==r);d(s=>({...s,images:a}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(p,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(m,{type:"text",id:"inspectedBy",value:f,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(p,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(m,{type:"text",id:"result",value:y(),disabled:!0,className:y()==="Desaprobado"?"text-red-600 font-bold":y()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(L,{type:"submit",className:"flex items-center",disabled:!E()||A,children:A?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})}export{pe as I};
