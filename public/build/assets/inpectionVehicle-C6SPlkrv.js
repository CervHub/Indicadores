import{U as I,j as e,m as fe,r as U,S as be}from"./app-2ocnS8h9.js";import{B as P}from"./button-DYED8VDT.js";import{I as b}from"./input-CluIwiun.js";import{L as T}from"./label-QDtIiUzW.js";import{S as ie,a as oe,b as le,c as de,f as q}from"./select-R6yFqbLe.js";import{t as D}from"./index-CViCya3V.js";import{I as ge}from"./image-Bl3aHc4Z.js";import{V as je}from"./utils-Dba3_-po.js";import{T as ve,a as Ne,b as W,c as z,d as ye,e as B}from"./table-B4lekv8i.js";import{D as te,b as se,c as ae,d as re}from"./dialog-Du4zvl2E.js";import{D as G}from"./download-CM-bXbB9.js";import{F as Z}from"./app-layout-MfkF6KhY.js";import{I as ne}from"./info-B9gg865T.js";import{T as we}from"./triangle-alert-yr9RAZSI.js";import{S as Ce}from"./search-34cN3l0Y.js";function _e(N){const[y,f]=I.useState(N.map(i=>({id:i.id,name:i.name,state:"",observation:""}))),[_,g]=I.useState({}),[E,c]=I.useState(!1),[w,o]=I.useState([]),[j,v]=I.useState(""),[h,M]=I.useState(null);return{causaStates:y,setCausaStates:f,extraFormData:_,setExtraFormData:g,modalOpen:E,setModalOpen:c,modalAttributes:w,setModalAttributes:o,modalTitle:j,setModalTitle:v,modalCausaId:h,setModalCausaId:M}}const Se=[{value:"4",label:"4",img:"/images/neumaticos/01.png"},{value:"6",label:"6",img:"/images/neumaticos/02.png"},{value:"10",label:"10",img:"/images/neumaticos/03.png"},{value:"12",label:"12",img:"/images/neumaticos/04.png"},{value:"14",label:"14",img:"/images/neumaticos/05.png"}];function Fe({attributes:N,causaId:y,extraFormData:f,setExtraFormData:_,causaState:g}){const E=f[y]||{},c=(o,j,v)=>{_(h=>({...h,[y]:{...h[y],[o]:j}}))};let w;if(g!=null&&g.name){const o=g.name.match(/^Neum[aá]ticos\s+(\d+)/i);if(console.log("Causa State Name:",g.name,"Match:",o),o){const j=o[1],v=Se.find(h=>h.value===j);w=v==null?void 0:v.img}}return e.jsxs("div",{className:"w-full",children:[e.jsx("form",{className:`\r
                    grid grid-cols-1 gap-4\r
                    sm:grid-cols-2\r
                    md:grid-cols-2\r
                    w-full\r
                `,children:N.map(o=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(T,{children:o.name}),o.attribute_type==="fecha"&&e.jsx(b,{type:"date",value:E[o.id]||"",onChange:j=>c(o.id,j.target.value,o.name)}),o.attribute_type==="entero"&&e.jsx(b,{type:"number",value:E[o.id]||"",onChange:j=>c(o.id,j.target.value,o.name)}),o.attribute_type==="texto"&&e.jsx(b,{type:"text",value:E[o.id]||"",onChange:j=>c(o.id,j.target.value,o.name)})]},o.id))}),w&&e.jsxs("div",{className:"w-full flex flex-col items-center mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground mb-2",children:"Referencia de neumáticos"}),e.jsx("img",{src:w,alt:"Referencia neumáticos",className:"max-w-xs max-h-92 "})]})]})}function Ie({causas:N,causaStates:y,setCausaStates:f,extraFormData:_,setExtraFormData:g,groupedCausas:E,modalOpen:c,setModalOpen:w,modalAttributes:o,setModalAttributes:j,modalTitle:v,setModalTitle:h,modalCausaId:M,setModalCausaId:i}){const C=l=>{const m=y.find(S=>S.id===l.id),n=(m==null?void 0:m.observation)||"",L=S=>O(l.id,void 0,S.target.value);function O(S,R,F){const V=y.map(A=>A.id===S?{...A,state:A.state,observation:F}:A);f(V)}switch(l.attribute_type){case"fecha":return e.jsx(b,{type:"date",value:n,onChange:L});case"entero":return e.jsx(b,{type:"number",value:n,onChange:L});case"texto":default:return e.jsx(b,{type:"text",value:n,onChange:L})}},H=l=>{if(!l.has_attributes||!l.category_attributes)return!0;const m=_[l.id]||{};return l.category_attributes.every(n=>!!m[n.id])};return I.useEffect(()=>{f(l=>l.map(m=>{const n=N.find(F=>F.id===m.id);if(!n||!n.has_attributes||!n.category_attributes||n.category_attributes.filter(F=>F.attribute_type==="fecha"&&F.min_value!==null).length===0)return m;const O=_[n.id]||{};let S=!0,R=!0;for(const F of n.category_attributes){const V=O[F.id];if(F.attribute_type==="fecha"&&F.min_value!==null){if(!V)S=!1;else if(F.min_value==="0"){const A=new Date;A.setHours(0,0,0,0);const $=new Date(V);$.setHours(0,0,0,0),$<A&&(S=!1)}}else V||(R=!1)}if(S&&R){if(m.state!=="Conforme")return{...m,state:"Conforme"}}else if(m.state!=="No Conforme")return{...m,state:"No Conforme"};return m}))},[_,N,f]),e.jsxs(e.Fragment,{children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:e.jsxs(W,{className:"bg-muted/50 border-b",children:[e.jsx(z,{className:"border-r text-center"}),e.jsx(z,{className:"border-r text-center",children:e.jsx(G,{className:"w-4 h-4 mx-auto"})}),e.jsx(z,{className:"border-r text-center sm:min-w-[400px] md:min-w-[400px] lg:min-w-[400px] xl:min-w-[800px]",children:"Causa"}),e.jsx(z,{className:"border-r text-center",children:e.jsx(Z,{className:"w-4 h-4 mx-auto"})}),e.jsx(z,{className:"border-r text-center",children:"Estado"}),e.jsx(z,{className:"text-center w-[50px] md:min-w-[50px]",children:"Observaciones"})]})}),e.jsx(ye,{children:Object.entries(E).map(([l,m])=>e.jsxs(I.Fragment,{children:[e.jsx(W,{className:"bg-muted/50",children:e.jsx(B,{colSpan:6,className:"text-center font-bold border-b",children:l})}),m.map(n=>{var L;return e.jsxs(W,{className:"border-b",children:[e.jsx(B,{className:"border-r text-center",children:n.instruction?e.jsxs(te,{children:[e.jsx(DialogTrigger,{asChild:!0,children:e.jsx(P,{type:"button",size:"icon",variant:"outline",className:"mx-0",children:e.jsx(ne,{className:"w-3 h-5"})})}),e.jsxs(se,{children:[e.jsx(ae,{children:e.jsx(re,{children:"Instrucción"})}),e.jsx("div",{className:"whitespace-pre-line",children:n.instruction})]})]}):e.jsx(P,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(ne,{className:"w-5 h-5"})})}),e.jsx(B,{className:"border-r text-center",children:n.document_url?e.jsx("a",{href:`/${n.document_url}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center text-blue-600",download:n.document_name||void 0,title:n.document_name||"Descargar",children:e.jsx(P,{type:"button",size:"icon",variant:"outline",className:"mx-auto",children:e.jsx(G,{className:"w-5 h-5"})})}):e.jsx(P,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(G,{className:"w-5 h-5"})})}),e.jsx(B,{className:"border-r font-medium whitespace-normal",children:n.nombre||n.name}),e.jsx(B,{className:"border-r text-center p-0 align-middle",children:n.has_attributes?e.jsxs(P,{type:"button",size:"icon",variant:"ghost",className:"mx-auto p-0 h-8 w-8 relative",onClick:()=>{j(n.category_attributes||[]),h(n.nombre||n.name||""),i(n.id),w(!0)},children:[e.jsx(Z,{className:"w-4 h-4"}),!H(n)&&e.jsx("span",{className:"absolute top-0 right-0 flex items-center animate-pulse",children:e.jsx(we,{className:"w-4 h-4 text-yellow-900 drop-shadow-[0_0_4px_rgba(255,193,7,0.8)]"})})]}):e.jsx(P,{type:"button",size:"icon",variant:"ghost",disabled:!0,className:"mx-auto opacity-50 p-0 h-8 w-8",children:e.jsx(Z,{className:"w-4 h-4"})})}),e.jsx(B,{className:"border-r text-center",children:e.jsxs(ie,{value:((L=y.find(O=>O.id===n.id))==null?void 0:L.state)||"",onValueChange:O=>f(S=>S.map(R=>R.id===n.id?{...R,state:O}:R)),children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione"})}),e.jsxs(de,{children:[e.jsx(q,{value:"Conforme",children:"Conforme"}),e.jsx(q,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(B,{children:C(n)})]},n.id)})]},l))})]}),e.jsx(te,{open:c,onOpenChange:l=>{w(l),l||i(null)},children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsx(re,{children:v})}),M&&e.jsx(Fe,{attributes:o,causaId:M,extraFormData:_,setExtraFormData:g,causaState:y.find(l=>l.id===M)})]})})]})}function Te(){const y=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),f=_=>{var g;return(g=y.find(E=>E.type===_))==null?void 0:g.value};return`${f("year")}-${f("month")}-${f("day")}T${f("hour")}:${f("minute")}`}function Ze({causas:N,type:y,userId:f,companyId:_,userName:g,company:E,area:c}){const w=N.filter(s=>{var t,a,r,p,d;return!((t=s.name)!=null&&t.toLowerCase().startsWith("neumáticos"))&&!((a=s.name)!=null&&a.toLowerCase().includes("grúa"))&&!((r=s.name)!=null&&r.toLowerCase().includes("grua"))&&!((p=s.name)!=null&&p.toLowerCase().includes("banderín"))&&!((d=s.name)!=null&&d.toLowerCase().includes("banderin"))}),o=N.filter(s=>{var t;return(t=s.name)==null?void 0:t.toLowerCase().startsWith("neumáticos")}),j=N.filter(s=>{var t,a;return((t=s.name)==null?void 0:t.toLowerCase().includes("grúa"))||((a=s.name)==null?void 0:a.toLowerCase().includes("grua"))}),v=N.filter(s=>{var t,a;return((t=s.name)==null?void 0:t.toLowerCase().includes("banderín"))||((a=s.name)==null?void 0:a.toLowerCase().includes("banderin"))});console.log("Causas filtradas base:",w);const[h,M]=I.useState(()=>{let s=[...w];if((c==null?void 0:c.toLowerCase())==="mina"){const t=v.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("rojo")});t&&s.push(t)}else{const t=v.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("verde")});t&&s.push(t)}return s});I.useEffect(()=>{let s=[...w];if((c==null?void 0:c.toLowerCase())==="mina"){const t=v.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("rojo")});t&&s.push(t)}else{const t=v.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("verde")});t&&s.push(t)}M(s)},[c]);const{data:i,setData:C,reset:H}=fe({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",mileage:"",company:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:Te(),companyId:_,userId:f,userName:g,type_report:"vehicular",type_inspection:y,causas:w.map(s=>({id:s.id,name:s.name,state:"",observation:""})),status:"",area:c}),{causaStates:l,setCausaStates:m,extraFormData:n,setExtraFormData:L,modalOpen:O,setModalOpen:S,modalAttributes:R,setModalAttributes:F,modalTitle:V,setModalTitle:A,modalCausaId:$,setModalCausaId:ce}=_e(h);I.useEffect(()=>{m(s=>h.map(a=>{const r=s.find(p=>p.id===a.id);return r||{id:a.id,name:a.name,state:"",observation:""}})),L(s=>{const t={...s};return h.forEach(a=>{a.id in t||(t[a.id]={})}),Object.keys(t).forEach(a=>{h.some(r=>String(r.id)===String(a))||delete t[a]}),t})},[h,m,L]),I.useEffect(()=>{C(s=>({...s,area:c}))},[c]);const[J,K]=U.useState(!1),[Le,De]=U.useState(!1),[Y,Q]=U.useState(!1),k=()=>l.some(s=>s.state==="No Conforme")?"Desaprobado":l.every(s=>s.state)?"Aprobado":"";I.useEffect(()=>{C("result",k()),C("status",k())},[l]);const X=()=>{const s=h.every(t=>{if(!t.has_attributes||!t.category_attributes)return!0;const a=n[t.id]||{};return t.category_attributes.every(r=>!!a[r.id])});return i.plate&&i.type&&i.brand&&i.model&&i.engineNumber&&i.year&&i.company&&k()&&l.every(t=>t.state)&&s},me=async()=>{if(!i.plate){D.error("Por favor, ingrese una placa para buscar.");return}K(!0),D.info("Buscando información para la placa...",{duration:3e3});try{const s=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:i.plate,company_id:_})),t=await s.json();if(s.ok&&t.status==="success"&&t.data){C(d=>({...d,vehicleCode:t.company.code+t.data.code||"",type:t.data.type||"",brand:t.data.brand||"",model:t.data.model||"",engineNumber:t.data.engine_number||"",year:t.data.year||"",company:t.company.nombre||""}));let a=[...w];if((c==null?void 0:c.toLowerCase())==="mina"){const d=v.find(x=>{var u;return(u=x.name)==null?void 0:u.toLowerCase().includes("rojo")});d&&a.push(d)}else{const d=v.find(x=>{var u;return(u=x.name)==null?void 0:u.toLowerCase().includes("verde")});d&&a.push(d)}const r=t.data.tire_count;if(r){const d=`Neumáticos ${Number(r)}`,x=o.find(u=>u.name===d);x&&!a.some(u=>u.id===x.id)&&(a=[...a,x])}const p=(t.data.type||"").toLowerCase();(p.includes("grúa")||p.includes("grua"))&&j.forEach(d=>{a.some(x=>x.id===d.id)||a.push(d)}),M(a),D.success("Información del vehículo cargada con éxito.")}else t.status==="warning"?(D.warning(t.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),C(a=>({...a,vehicleCode:""}))):t.status==="error"?(D.error(t.message||"No se encontró información para la placa ingresada."),C(a=>({...a,vehicleCode:""}))):(D.error("No se encontró información para la placa ingresada."),C(a=>({...a,vehicleCode:""})))}catch(s){console.error(s),D.error("Ocurrió un error al buscar la placa."),C(t=>({...t,vehicleCode:""}))}finally{K(!1)}},ue=async s=>{if(s.preventDefault(),!X()){D.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}Q(!0);try{const t=l.map(r=>{const p=n[r.id]||{};let d=[];const x=N.find(u=>u.id===r.id);return x&&x.category_attributes&&(d=x.category_attributes.map(u=>({id:u.id,value:p[u.id]??"",name:u.name}))),{...r,extraForm:d}}),a=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...i,causas:t,status:k()})});if(a.ok){const r=await a.json();D.success(r.message||"Reporte guardado con éxito."),H(),m(N.map(p=>({id:p.id,state:"",observation:""}))),be.visit(route("admin.reportability"))}else if(a.status===422){const r=await a.json();D.error("Errores de validación en el formulario."),console.error(r.errors)}else throw new Error("Error al guardar el reporte.")}catch(t){console.error(t),D.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{Q(!1)}},he=h.reduce((s,t)=>(s[t.group]||(s[t.group]=[]),s[t.group].push(t),s),{});return e.jsx(e.Fragment,{children:e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:ue,children:[e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(b,{type:"text",id:"plate",value:i.plate||"",onChange:s=>C("plate",s.target.value),className:"flex-1"}),e.jsx(P,{variant:"outline",type:"button",onClick:me,className:"flex items-center px-2",disabled:J,children:J?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(Ce,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(b,{type:"text",id:"vehicleCode",value:i.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(ie,{value:i.type,disabled:!0,children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione un tipo"})}),e.jsx(de,{children:je.map(({value:s,label:t})=>e.jsx(q,{value:s,children:t},s))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(b,{type:"text",id:"brand",value:i.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(b,{type:"text",id:"model",value:i.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(b,{type:"text",id:"engineNumber",value:i.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(b,{type:"text",id:"year",value:i.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(b,{type:"text",id:"company",value:i.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(b,{type:"number",id:"mileage",value:i.mileage||"",onChange:s=>{const t=s.target.value.replace(/\D/g,"").slice(0,7);C("mileage",t)},min:0,max:9999999,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsx(Ie,{causas:h,causaStates:l,setCausaStates:m,extraFormData:n,setExtraFormData:L,groupedCausas:he,modalOpen:O,setModalOpen:S,modalAttributes:R,setModalAttributes:F,modalTitle:V,setModalTitle:A,modalCausaId:$,setModalCausaId:ce})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(ge,{images:i.images,onUpload:s=>{s.forEach(t=>{const a=new FileReader;a.onload=()=>{const r=a.result,p=new Image;p.src=r,p.onload=()=>{const d=document.createElement("canvas"),x=d.getContext("2d"),u=800,pe=u/p.width;d.width=u,d.height=p.height*pe,x==null||x.drawImage(p,0,0,d.width,d.height);const xe=d.toDataURL("image/jpeg",.8);C(ee=>({...ee,images:[...ee.images,xe].slice(0,4)}))}},a.readAsDataURL(t)})},onRemove:s=>{const t=i.images.filter((a,r)=>r!==s);C(a=>({...a,images:t}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(T,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(b,{type:"text",id:"inspectedBy",value:g,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(T,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(b,{type:"text",id:"result",value:k(),disabled:!0,className:k()==="Desaprobado"?"text-red-600 font-bold":k()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(P,{type:"submit",className:"flex items-center",disabled:!X()||Y,children:Y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})})}export{Ze as I};
