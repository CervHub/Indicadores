import{r as b,U as F,m as te,j as e,S as re,K as oe,L as ne}from"./app-CkX-sCCf.js";import{B as Z}from"./button-Bw2Xdp6E.js";import{I as p}from"./input-MjwaqtbJ.js";import{L as h}from"./label-B68sH3c7.js";import{S as q,a as z,b as J,c as W,f as R}from"./select-DPNjP_Lz.js";import{T as ie,a as le,b as B,c as k,d as ce,e as A}from"./table-DskUy7h3.js";import{t as m}from"./index-uPTyyJTB.js";import{I as de}from"./image-x3VN068n.js";import{V as me}from"./utils-Co_qxGNv.js";import{S as ue}from"./search-fTzzglXd.js";import{A as pe}from"./app-layout-NwK8qtki.js";import he from"./statement-B0f__a0t.js";import"./index-ItJPPwpU.js";import"./index-BbjDzo9d.js";import"./index-BeeyGmDn.js";import"./index-C0Urlq2e.js";import"./createLucideIcon-Cux2gun-.js";import"./index-RgIy1NKL.js";import"./index-DiuJ2rgF.js";import"./check-DYdSJAZQ.js";import"./index-CNC3jUVX.js";import"./index-CswDWhBD.js";import"./index-Chjiymov.js";import"./circle-x-B9c8PN4K.js";import"./tooltip-CeYhT-Ve.js";import"./chevrons-up-down-BuW2oQV_.js";import"./truck-CJs_TKyA.js";import"./file-text-BQQHQTRf.js";import"./chevron-right-D5H3JAm1.js";import"./dialog-CQ0eMQJ3.js";function fe(){const x=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),f=j=>{var v;return(v=x.find(_=>_.type===j))==null?void 0:v.value};return`${f("year")}-${f("month")}-${f("day")}T${f("hour")}:${f("minute")}`}function xe({causas:u,type:x,userId:f,companyId:j,userName:v,company:_,area:l}){const P=u.filter(a=>a.is_crane===!0),C=u.filter(a=>a.is_for_mine===!0),w=u.filter(a=>a.is_not_for_mine===!0),y=u.filter(a=>!a.is_crane&&!a.is_for_mine&&!a.is_not_for_mine),V=[...y,...(l==null?void 0:l.toLowerCase())==="mina"?C:w],[N,E]=b.useState(V);F.useEffect(()=>{const a=[...y,...(l==null?void 0:l.toLowerCase())==="mina"?C:w];E(a)},[l,u]);const{data:r,setData:c,reset:O}=te({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",company:"",mileage:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:fe(),companyId:j,userId:f,userName:v,type_report:"vehicular",type_inspection:x,causas:u.map(a=>({id:a.id,name:a.name,state:"",observation:""})),status:"",area:l});F.useEffect(()=>{c(a=>({...a,area:l}))},[l]);const[d,I]=b.useState(N.map(a=>({id:a.id,name:a.name,state:"",observation:""})));F.useEffect(()=>{I(a=>N.map(t=>{const n=a.find(o=>o.id===t.id);return n||{id:t.id,name:t.name,state:"",observation:""}}))},[N]);const[T,L]=b.useState(!1),[M,$]=b.useState(!1),[G,U]=b.useState(!1),g=()=>d.some(a=>a.state==="No Conforme")?"Desaprobado":d.every(a=>a.state)?"Aprobado":"";F.useEffect(()=>{c("result",g()),c("status",g())},[d]);const H=()=>r.plate&&r.type&&r.brand&&r.model&&r.engineNumber&&r.year&&r.company&&g()&&d.every(a=>a.state),K=(a,s,t)=>{const n=d.map(o=>o.id===a?{...o,state:s!==void 0?s:o.state,observation:t}:o);I(n),c("causas",n)},Q=async()=>{if(!r.plate){m.error("Por favor, ingrese una placa para buscar.");return}L(!0),m.info("Buscando información para la placa...",{duration:3e3});try{const a=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:r.plate,company_id:j})),s=await a.json();if(a.ok&&s.status==="success"&&s.data){c(o=>({...o,vehicleCode:s.company.code+"-"+s.data.code||"",type:s.data.type||"",brand:s.data.brand||"",model:s.data.model||"",engineNumber:s.data.engine_number||"",year:s.data.year||"",company:s.company.nombre||""}));let t=[...y,...(l==null?void 0:l.toLowerCase())==="mina"?C:w];const n=(s.data.type||"").toLowerCase();(n.includes("grúa")||n.includes("grua"))&&P.forEach(o=>{t.some(i=>i.id===o.id)||t.push(o)}),E(t),m.success("Información del vehículo cargada con éxito.")}else s.status==="warning"?(m.warning(s.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),c(t=>({...t,vehicleCode:""}))):s.status==="error"?(m.error(s.message||"No se encontró información para la placa ingresada."),c(t=>({...t,vehicleCode:""}))):(m.error("No se encontró información para la placa ingresada."),c(t=>({...t,vehicleCode:""})))}catch(a){console.error(a),m.error("Ocurrió un error al buscar la placa."),c(s=>({...s,vehicleCode:""}))}finally{L(!1)}},X=async a=>{if(a.preventDefault(),!H()){m.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}U(!0);try{const s=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,causas:d,status:g()})});if(s.ok){const t=await s.json();m.success(t.message||"Reporte guardado con éxito."),re.visit(route("admin.reportability")),O(),I(u.map(n=>({id:n.id,state:"",observation:""})))}else if(s.status===422){const t=await s.json();m.error("Errores de validación en el formulario."),console.error(t.errors)}else throw new Error("Error al guardar el reporte.")}catch(s){console.error(s),m.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{U(!1)}},ee=N.reduce((a,s)=>(a[s.group]||(a[s.group]=[]),a[s.group].push(s),a),{});return e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:X,children:[e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(p,{type:"text",id:"plate",value:r.plate||"",onChange:a=>c("plate",a.target.value),className:"flex-1"}),e.jsx(Z,{variant:"outline",type:"button",onClick:Q,className:"flex items-center px-2",disabled:T,children:T?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(ue,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(p,{type:"text",id:"vehicleCode",value:r.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(q,{value:r.type,disabled:!0,children:[e.jsx(z,{className:"w-full",children:e.jsx(J,{placeholder:"Seleccione un tipo"})}),e.jsx(W,{children:me.map(({value:a,label:s})=>e.jsx(R,{value:a,children:s},a))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(p,{type:"text",id:"brand",value:r.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(p,{type:"text",id:"model",value:r.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(p,{type:"text",id:"engineNumber",value:r.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(p,{type:"text",id:"year",value:r.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(p,{type:"text",id:"company",value:r.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(h,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(p,{type:"number",id:"mileage",value:r.mileage||"",onChange:a=>c("mileage",a.target.value),min:0,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(B,{className:"bg-muted/50 border-b",children:[e.jsx(k,{className:"h-8 border-r py-2",rowSpan:2,style:{width:"50%"},children:"Item"}),e.jsx(k,{className:"h-8 border-r py-2",colSpan:1,children:"Estado"}),e.jsx(k,{className:"h-8 border-l py-2",rowSpan:2,style:{width:"20%"},children:"Observaciones"})]})}),e.jsx(ce,{children:Object.entries(ee).map(([a,s])=>e.jsxs(F.Fragment,{children:[e.jsx(B,{className:"bg-muted/50",children:e.jsx(A,{colSpan:3,className:"text-center font-bold",children:a})}),s.map(t=>{var n,o;return e.jsxs(B,{children:[e.jsx(A,{className:"border-r py-1 font-medium whitespace-normal",children:t.name}),e.jsx(A,{className:"text-center",children:e.jsxs(q,{value:((n=d.find(i=>i.id===t.id))==null?void 0:n.state)||"",onValueChange:i=>{var S;return K(t.id,i,((S=d.find(D=>D.id===t.id))==null?void 0:S.observation)||"")},children:[e.jsx(z,{className:"w-full",children:e.jsx(J,{placeholder:"Seleccione"})}),e.jsxs(W,{children:[e.jsx(R,{value:"Conforme",children:"Conforme"}),e.jsx(R,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(A,{children:e.jsx(p,{type:"text",value:((o=d.find(i=>i.id===t.id))==null?void 0:o.observation)||"",onChange:i=>K(t.id,void 0,i.target.value)})})]},t.id)})]},a))})]})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(de,{images:r.images,onUpload:a=>{a.forEach(s=>{const t=new FileReader;t.onload=()=>{const n=t.result,o=new Image;o.src=n,o.onload=()=>{const i=document.createElement("canvas"),S=i.getContext("2d"),D=800,ae=D/o.width;i.width=D,i.height=o.height*ae,S==null||S.drawImage(o,0,0,i.width,i.height);const se=i.toDataURL("image/jpeg",.8);c(Y=>({...Y,images:[...Y.images,se].slice(0,4)}))}},t.readAsDataURL(s)})},onRemove:a=>{const s=r.images.filter((t,n)=>n!==a);c(t=>({...t,images:s}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(h,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(p,{type:"text",id:"result",value:g(),disabled:!0,className:g()==="Desaprobado"?"text-red-600 font-bold":g()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(Z,{type:"submit",className:"flex items-center",disabled:!H()||G,children:G?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})}const ge=[{title:"Gestión de Formatos",href:"/format"},{title:"Inspección Vehicular Semestral",href:"/semiannual-vehicle-inspection"}],be="semestral";function ze(){const{causas:u,auth:x}=oe().props,[f,j]=b.useState(!0),v=x.user.id,_=x.user.company_id,l=x.user.name,P=x.user.company,[C,w]=b.useState(""),y=u.map(({id:V,nombre:N,group:E,is_crane:r,is_for_mine:c,is_not_for_mine:O,instruction:d,document_url:I,document_name:T,attribute_type:L,has_attributes:M,category_attributes:$})=>({id:V,name:N,group:E,is_crane:r,is_for_mine:c,is_not_for_mine:O,instruction:d,document_url:I,document_name:T,attribute_type:L,has_attributes:M,category_attributes:$}));return console.log("Filtered Causas:",y),e.jsxs(pe,{breadcrumbs:ge,children:[e.jsx(ne,{title:"Inspección Vehicular Semestral"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4",children:e.jsx(xe,{causas:y,type:be,userId:v,companyId:_,userName:l,company:P,area:C})}),e.jsx(he,{open:f,onOpenChange:j,setArea:w})]})}export{ze as default};
