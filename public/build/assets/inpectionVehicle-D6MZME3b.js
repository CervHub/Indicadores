import{U as D,j as e,m as fe,r as U,S as be}from"./app-Bmcdr3rY.js";import{B as P}from"./button-DTKbtbr3.js";import{I as N}from"./input-iTO7QCEj.js";import{L as T}from"./label-CxH93Fcg.js";import{S as ie,a as oe,b as le,c as de,f as q}from"./select-BAHjfWcY.js";import{t as L}from"./index-C5uH-olr.js";import{I as ge}from"./image-BUGwGEpI.js";import{C as je,V as Ne}from"./utils-CISCwvQU.js";import{T as ve,a as ye,b as W,c as k,d as we,e as B}from"./table-gNZ6VK7S.js";import{D as se,a as Ce,b as te,c as ae,d as ne}from"./dialog-DRTvkdgv.js";import{D as G}from"./download-DNPJ2szw.js";import{F as Z}from"./app-layout-P0V2GsON.js";import{I as re}from"./info-CfJcWIAK.js";import{T as _e}from"./triangle-alert-Cht-uZGS.js";import{S as De}from"./search-B7JmLQoT.js";function Se(v){const[y,j]=D.useState(v.map(r=>({id:r.id,name:r.name,state:"",observation:""}))),[_,w]=D.useState({}),[I,x]=D.useState(!1),[S,$]=D.useState([]),[A,a]=D.useState(""),[i,c]=D.useState(null);return{causaStates:y,setCausaStates:j,extraFormData:_,setExtraFormData:w,modalOpen:I,setModalOpen:x,modalAttributes:S,setModalAttributes:$,modalTitle:A,setModalTitle:a,modalCausaId:i,setModalCausaId:c}}const Fe=[{value:"4",label:"4",img:"/images/neumaticos/01.png"},{value:"6",label:"6",img:"/images/neumaticos/02.png"},{value:"10",label:"10",img:"/images/neumaticos/03.png"},{value:"12",label:"12",img:"/images/neumaticos/04.png"},{value:"14",label:"14",img:"/images/neumaticos/05.png"}];function Te({attributes:v,causaId:y,extraFormData:j,setExtraFormData:_,causaState:w}){const I=j[y]||{};function x(a){if(!a)return"";const i=je.find(c=>c.value===a);return i?i.label:a}function S(a,i){let c=!1,r="";if(a.attribute_type==="fecha"&&a.min_value!==null&&a.min_value!==void 0){if(a.min_value==="0"){if(r="Debe ser mayor o igual a hoy",i){const u=new Date;u.setHours(0,0,0,0);const E=new Date(i);E.setHours(0,0,0,0),c=E>=u}}else if(!isNaN(Number(a.min_value))&&(r=`Debe ser al menos dentro de ${a.min_value} días`,i)){const u=new Date;u.setHours(0,0,0,0);const E=new Date(u);E.setDate(u.getDate()+Number(a.min_value));const d=new Date(i);d.setHours(0,0,0,0),c=d>=E}}else a.attribute_type==="entero"&&a.min_value!==null&&a.min_value!==void 0?(r=`Debe ser mayor o igual a ${a.min_value}`,i!==void 0&&i!==""&&!isNaN(Number(i))&&(c=Number(i)>=Number(a.min_value))):(a.attribute_type,r="Debe estar lleno",c=!!i&&i!=="");return{cumple:c,regla:r}}const $=(a,i,c,r)=>{const{cumple:u,regla:E}=S(r,i);_(d=>({...d,[y]:{...d[y],[a]:i,[`${a}_nombre`]:c,[`${a}_cumple`]:u,[`${a}_regla`]:E,[`${a}_conforme`]:u?"Conforme":"No Conforme"}}))};let A;if(w!=null&&w.name){const a=w.name.match(/^Neum[aá]ticos\s+(\d+)/i);if(a){const i=a[1],c=Fe.find(r=>r.value===i);A=c==null?void 0:c.img}}return e.jsxs("div",{className:"w-full",children:[e.jsx("form",{className:`
                    grid grid-cols-1 gap-4
                    sm:grid-cols-2
                    md:grid-cols-2
                    w-full
                `,children:v.map(a=>{const i=I[a.id];return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(T,{children:[a.name,a.unit&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["(",x(a.unit),")"]})]}),a.attribute_type==="fecha"&&e.jsx(N,{type:"date",value:i||"",onChange:c=>$(a.id,c.target.value,a.name,a)}),a.attribute_type==="entero"&&e.jsx(N,{type:"number",value:i||"",onChange:c=>$(a.id,c.target.value,a.name,a)}),a.attribute_type==="texto"&&e.jsx(N,{type:"text",value:i||"",onChange:c=>$(a.id,c.target.value,a.name,a)}),I[`${a.id}_regla`]&&e.jsxs("span",{className:"text-xs mt-1",children:["Estado: ",I[`${a.id}_conforme`]||""]})]},a.id)})}),A&&e.jsxs("div",{className:"w-full flex flex-col items-center mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground mb-2",children:"Referencia de neumáticos"}),e.jsx("img",{src:A,alt:"Referencia neumáticos",className:"max-w-xs max-h-92 "})]})]})}function Ee({causas:v,causaStates:y,setCausaStates:j,extraFormData:_,setExtraFormData:w,groupedCausas:I,modalOpen:x,setModalOpen:S,modalAttributes:$,setModalAttributes:A,modalTitle:a,setModalTitle:i,modalCausaId:c,setModalCausaId:r}){const u=d=>{const p=y.find(O=>O.id===d.id),l=(p==null?void 0:p.observation)||"",F=O=>V(d.id,void 0,O.target.value);function V(O,h,C){const R=y.map(M=>M.id===O?{...M,state:M.state,observation:C}:M);j(R)}switch(d.attribute_type){case"fecha":return e.jsx(N,{type:"date",value:l,onChange:F});case"entero":return e.jsx(N,{type:"number",value:l,onChange:F});case"texto":default:return e.jsx(N,{type:"text",value:l,onChange:F})}},E=d=>{if(!d.has_attributes||!d.category_attributes)return!0;const p=_[d.id]||{};return d.category_attributes.every(l=>!!p[l.id])};return D.useEffect(()=>{j(d=>d.map(p=>{const l=v.find(h=>h.id===p.id);if(!l||!l.has_attributes||!l.category_attributes)return p;const F=_[l.id]||{};if(l.category_attributes.map(h=>{const C=F[h.id];let R=!1;if(h.attribute_type==="fecha"&&h.min_value!==null){if(C)if(h.min_value==="0"){const M=new Date;M.setHours(0,0,0,0);const z=new Date(C);z.setHours(0,0,0,0),R=z>=M}else R=!0}else h.attribute_type==="entero"&&h.min_value!==null?C!==void 0&&C!==""&&!isNaN(Number(C))&&(R=Number(C)>=Number(h.min_value)):(h.attribute_type,R=!!C&&C!=="");return{attrId:h.id,cumple:R}}).every(h=>h.cumple)){if(p.state!=="Conforme")return{...p,state:"Conforme"}}else if(p.state!=="No Conforme")return{...p,state:"No Conforme"};return p}))},[_,v,j]),e.jsxs(e.Fragment,{children:[e.jsxs(ve,{children:[e.jsx(ye,{children:e.jsxs(W,{className:"bg-muted/50 border-b",children:[e.jsx(k,{className:"border-r text-center"}),e.jsx(k,{className:"border-r text-center",children:e.jsx(G,{className:"w-4 h-4 mx-auto"})}),e.jsx(k,{className:"border-r text-center sm:min-w-[400px] md:min-w-[400px] lg:min-w-[400px] xl:min-w-[800px]",children:"Causa"}),e.jsx(k,{className:"border-r text-center",children:e.jsx(Z,{className:"w-4 h-4 mx-auto"})}),e.jsx(k,{className:"border-r text-center",children:"Estado"}),e.jsx(k,{className:"text-center w-[50px] md:min-w-[50px]",children:"Observaciones"})]})}),e.jsx(we,{children:Object.entries(I).map(([d,p])=>e.jsxs(D.Fragment,{children:[e.jsx(W,{className:"bg-muted/50",children:e.jsx(B,{colSpan:6,className:"text-center font-bold border-b",children:d})}),p.map(l=>{var F;return e.jsxs(W,{className:"border-b",children:[e.jsx(B,{className:"border-r text-center",children:l.instruction?e.jsxs(se,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(P,{type:"button",size:"icon",variant:"outline",className:"mx-0",children:e.jsx(re,{className:"w-3 h-5"})})}),e.jsxs(te,{children:[e.jsx(ae,{children:e.jsx(ne,{children:"Instrucción"})}),e.jsx("div",{className:"whitespace-pre-line",children:l.instruction})]})]}):e.jsx(P,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(re,{className:"w-5 h-5"})})}),e.jsx(B,{className:"border-r text-center",children:l.document_url?e.jsx("a",{href:`/${l.document_url}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center text-blue-600",download:l.document_name||void 0,title:l.document_name||"Descargar",children:e.jsx(P,{type:"button",size:"icon",variant:"outline",className:"mx-auto",children:e.jsx(G,{className:"w-5 h-5"})})}):e.jsx(P,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(G,{className:"w-5 h-5"})})}),e.jsx(B,{className:"border-r font-medium whitespace-normal",children:l.nombre||l.name}),e.jsx(B,{className:"border-r text-center p-0 align-middle",children:l.has_attributes?e.jsxs(P,{type:"button",size:"icon",variant:"ghost",className:"mx-auto p-0 h-8 w-8 relative",onClick:()=>{A(l.category_attributes||[]),i(l.nombre||l.name||""),r(l.id),S(!0)},children:[e.jsx(Z,{className:"w-4 h-4"}),!E(l)&&e.jsx("span",{className:"absolute top-0 right-0 flex items-center animate-pulse",children:e.jsx(_e,{className:"w-4 h-4 text-yellow-900 drop-shadow-[0_0_4px_rgba(255,193,7,0.8)]"})})]}):e.jsx(P,{type:"button",size:"icon",variant:"ghost",disabled:!0,className:"mx-auto opacity-50 p-0 h-8 w-8",children:e.jsx(Z,{className:"w-4 h-4"})})}),e.jsx(B,{className:"border-r text-center",children:e.jsxs(ie,{value:((F=y.find(V=>V.id===l.id))==null?void 0:F.state)||"",onValueChange:V=>j(O=>O.map(h=>h.id===l.id?{...h,state:V}:h)),children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione"})}),e.jsxs(de,{children:[e.jsx(q,{value:"Conforme",children:"Conforme"}),e.jsx(q,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(B,{children:u(l)})]},l.id)})]},d))})]}),e.jsx(se,{open:x,onOpenChange:d=>{S(d),d||r(null)},children:e.jsxs(te,{children:[e.jsx(ae,{children:e.jsx(ne,{children:a})}),c&&e.jsx(Te,{attributes:$,causaId:c,extraFormData:_,setExtraFormData:w,causaState:y.find(d=>d.id===c)})]})})]})}function Le(){const y=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),j=_=>{var w;return(w=y.find(I=>I.type===_))==null?void 0:w.value};return`${j("year")}-${j("month")}-${j("day")}T${j("hour")}:${j("minute")}`}function Je({causas:v,type:y,userId:j,companyId:_,userName:w,company:I,area:x}){const S=v.filter(t=>{var s,n,o,b,m;return!((s=t.name)!=null&&s.toLowerCase().startsWith("neumáticos"))&&!((n=t.name)!=null&&n.toLowerCase().includes("grúa"))&&!((o=t.name)!=null&&o.toLowerCase().includes("grua"))&&!((b=t.name)!=null&&b.toLowerCase().includes("banderín"))&&!((m=t.name)!=null&&m.toLowerCase().includes("banderin"))}),$=v.filter(t=>{var s;return(s=t.name)==null?void 0:s.toLowerCase().startsWith("neumáticos")}),A=v.filter(t=>{var s,n;return((s=t.name)==null?void 0:s.toLowerCase().includes("grúa"))||((n=t.name)==null?void 0:n.toLowerCase().includes("grua"))}),a=v.filter(t=>{var s,n;return((s=t.name)==null?void 0:s.toLowerCase().includes("banderín"))||((n=t.name)==null?void 0:n.toLowerCase().includes("banderin"))});console.log("Causas filtradas base:",S);const[i,c]=D.useState(()=>{let t=[...S];if((x==null?void 0:x.toLowerCase())==="mina"){const s=a.find(n=>{var o;return(o=n.name)==null?void 0:o.toLowerCase().includes("rojo")});s&&t.push(s)}else{const s=a.find(n=>{var o;return(o=n.name)==null?void 0:o.toLowerCase().includes("verde")});s&&t.push(s)}return t});D.useEffect(()=>{let t=[...S];if((x==null?void 0:x.toLowerCase())==="mina"){const s=a.find(n=>{var o;return(o=n.name)==null?void 0:o.toLowerCase().includes("rojo")});s&&t.push(s)}else{const s=a.find(n=>{var o;return(o=n.name)==null?void 0:o.toLowerCase().includes("verde")});s&&t.push(s)}c(t)},[x]);const{data:r,setData:u,reset:E}=fe({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",mileage:"",company:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:Le(),companyId:_,userId:j,userName:w,type_report:"vehicular",type_inspection:y,causas:S.map(t=>({id:t.id,name:t.name,state:"",observation:""})),status:"",area:x}),{causaStates:d,setCausaStates:p,extraFormData:l,setExtraFormData:F,modalOpen:V,setModalOpen:O,modalAttributes:h,setModalAttributes:C,modalTitle:R,setModalTitle:M,modalCausaId:z,setModalCausaId:ce}=Se(i);D.useEffect(()=>{p(t=>i.map(n=>{const o=t.find(b=>b.id===n.id);return o||{id:n.id,name:n.name,state:"",observation:""}})),F(t=>{const s={...t};return i.forEach(n=>{n.id in s||(s[n.id]={})}),Object.keys(s).forEach(n=>{i.some(o=>String(o.id)===String(n))||delete s[n]}),s})},[i,p,F]),D.useEffect(()=>{u(t=>({...t,area:x}))},[x]);const[J,K]=U.useState(!1),[Ie,Oe]=U.useState(!1),[Y,Q]=U.useState(!1),H=()=>d.some(t=>t.state==="No Conforme")?"Desaprobado":d.every(t=>t.state)?"Aprobado":"";D.useEffect(()=>{u("result",H()),u("status",H())},[d]);const X=()=>{const t=i.every(s=>{if(!s.has_attributes||!s.category_attributes)return!0;const n=l[s.id]||{};return s.category_attributes.every(o=>!!n[o.id])});return r.plate&&r.type&&r.brand&&r.model&&r.engineNumber&&r.year&&r.company&&H()&&d.every(s=>s.state)&&t},me=async()=>{if(!r.plate){L.error("Por favor, ingrese una placa para buscar.");return}K(!0),L.info("Buscando información para la placa...",{duration:3e3});try{const t=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:r.plate,company_id:_})),s=await t.json();if(t.ok&&s.status==="success"&&s.data){u(m=>({...m,vehicleCode:s.company.code+s.data.code||"",type:s.data.type||"",brand:s.data.brand||"",model:s.data.model||"",engineNumber:s.data.engine_number||"",year:s.data.year||"",company:s.company.nombre||""}));let n=[...S];if((x==null?void 0:x.toLowerCase())==="mina"){const m=a.find(g=>{var f;return(f=g.name)==null?void 0:f.toLowerCase().includes("rojo")});m&&n.push(m)}else{const m=a.find(g=>{var f;return(f=g.name)==null?void 0:f.toLowerCase().includes("verde")});m&&n.push(m)}const o=s.data.tire_count;if(o){const m=`Neumáticos ${Number(o)}`,g=$.find(f=>f.name===m);g&&!n.some(f=>f.id===g.id)&&(n=[...n,g])}const b=(s.data.type||"").toLowerCase();(b.includes("grúa")||b.includes("grua"))&&A.forEach(m=>{n.some(g=>g.id===m.id)||n.push(m)}),c(n),L.success("Información del vehículo cargada con éxito.")}else s.status==="warning"?(L.warning(s.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),u(n=>({...n,vehicleCode:""}))):s.status==="error"?(L.error(s.message||"No se encontró información para la placa ingresada."),u(n=>({...n,vehicleCode:""}))):(L.error("No se encontró información para la placa ingresada."),u(n=>({...n,vehicleCode:""})))}catch(t){console.error(t),L.error("Ocurrió un error al buscar la placa."),u(s=>({...s,vehicleCode:""}))}finally{K(!1)}},ue=async t=>{if(t.preventDefault(),!X()){L.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}Q(!0);try{const s=d.map(o=>{const b=l[o.id]||{};let m=[];const g=v.find(f=>f.id===o.id);return g&&g.category_attributes&&(m=g.category_attributes.map(f=>({id:f.id,value:b[f.id]??"",name:f.name,status:b[`${f.id}_cumple`]===!0}))),{...o,extraForm:m}}),n=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,causas:s,status:H()})});if(n.ok){const o=await n.json();L.success(o.message||"Reporte guardado con éxito."),E(),p(v.map(b=>({id:b.id,state:"",observation:""}))),be.visit(route("admin.reportability"))}else if(n.status===422){const o=await n.json();L.error("Errores de validación en el formulario."),console.error(o.errors)}else throw new Error("Error al guardar el reporte.")}catch(s){console.error(s),L.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{Q(!1)}},pe=i.reduce((t,s)=>(t[s.group]||(t[s.group]=[]),t[s.group].push(s),t),{});return e.jsx(e.Fragment,{children:e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:ue,children:[e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(N,{type:"text",id:"plate",value:r.plate||"",onChange:t=>u("plate",t.target.value),className:"flex-1"}),e.jsx(P,{variant:"outline",type:"button",onClick:me,className:"flex items-center px-2",disabled:J,children:J?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(De,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(N,{type:"text",id:"vehicleCode",value:r.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(ie,{value:r.type,disabled:!0,children:[e.jsx(oe,{className:"w-full",children:e.jsx(le,{placeholder:"Seleccione un tipo"})}),e.jsx(de,{children:Ne.map(({value:t,label:s})=>e.jsx(q,{value:t,children:s},t))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(N,{type:"text",id:"brand",value:r.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(N,{type:"text",id:"model",value:r.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(N,{type:"text",id:"engineNumber",value:r.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(N,{type:"text",id:"year",value:r.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(N,{type:"text",id:"company",value:r.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(T,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(N,{type:"number",id:"mileage",value:r.mileage||"",onChange:t=>{const s=t.target.value.replace(/\D/g,"").slice(0,7);u("mileage",s)},min:0,max:9999999,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsx(Ee,{causas:i,causaStates:d,setCausaStates:p,extraFormData:l,setExtraFormData:F,groupedCausas:pe,modalOpen:V,setModalOpen:O,modalAttributes:h,setModalAttributes:C,modalTitle:R,setModalTitle:M,modalCausaId:z,setModalCausaId:ce})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(ge,{images:r.images,onUpload:t=>{t.forEach(s=>{const n=new FileReader;n.onload=()=>{const o=n.result,b=new Image;b.src=o,b.onload=()=>{const m=document.createElement("canvas"),g=m.getContext("2d"),f=800,he=f/b.width;m.width=f,m.height=b.height*he,g==null||g.drawImage(b,0,0,m.width,m.height);const xe=m.toDataURL("image/jpeg",.8);u(ee=>({...ee,images:[...ee.images,xe].slice(0,4)}))}},n.readAsDataURL(s)})},onRemove:t=>{const s=r.images.filter((n,o)=>o!==t);u(n=>({...n,images:s}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(T,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(N,{type:"text",id:"inspectedBy",value:w,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(T,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(N,{type:"text",id:"result",value:H(),disabled:!0,className:H()==="Desaprobado"?"text-red-600 font-bold":H()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(P,{type:"submit",className:"flex items-center",disabled:!X()||Y,children:Y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})})}export{Je as I};
