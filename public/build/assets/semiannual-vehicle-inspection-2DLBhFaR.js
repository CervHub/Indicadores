import{m as q,U as E,r as v,j as e,K as z,L as J}from"./app-BGRtgKnc.js";import{B}from"./button-CE9Kfrma.js";import{I as d}from"./input-BoAbue13.js";import{L as m}from"./label-Cm3ysutb.js";import{S as k,a as $,b as U,c as G,f as D}from"./select-Tam4fzSJ.js";import{T as W,a as Q,b as L,c as A,d as X,e as F}from"./table-c9FaAR0Q.js";import{t as p}from"./index-BfxxhM4v.js";import{I as ee}from"./image-frnSJ1iS.js";import{V as ae}from"./utils-qLzneZb4.js";import{S as se}from"./search-CPr3D1JY.js";import{A as re}from"./app-layout-D16Qdz7A.js";import te from"./statement-C61PeEme.js";import"./index-DlJ4QY3O.js";import"./index-BRgIlbTm.js";import"./index-BAc0eoxY.js";import"./index-CNOFbD9E.js";import"./createLucideIcon-2L4VWm-a.js";import"./index-s5X9s_Ke.js";import"./index-Cf2cvOEd.js";import"./check-r1RKSXM0.js";import"./index-ChkzfJ-S.js";import"./index-B8ApXDXg.js";import"./index-Chjiymov.js";import"./tooltip-BM6UytuT.js";import"./chevrons-up-down-DL7jijce.js";import"./truck-DybPSL_n.js";import"./chevron-right-W7gyJoai.js";import"./dialog-BXg_oST7.js";function oe(){const h=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),u=g=>{var f;return(f=h.find(N=>N.type===g))==null?void 0:f.value};return`${u("year")}-${u("month")}-${u("day")}T${u("hour")}:${u("minute")}`}function ne({causas:x,type:h,userId:u,companyId:g,userName:f,company:N,area:y}){const{data:t,setData:o,reset:T}=q({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",company:"",mileage:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:oe(),companyId:g,userId:u,userName:f,type_report:"vehicular",type_inspection:h,causas:x.map(a=>({id:a.id,name:a.name,state:"",observation:""})),status:"",area:y});E.useEffect(()=>{o(a=>({...a,area:y}))},[y]);const[i,S]=v.useState(x.map(a=>({id:a.id,name:a.name,state:"",observation:""}))),[C,w]=v.useState(!1),[ce,de]=v.useState(!1),[P,O]=v.useState(!1),b=()=>i.some(a=>a.state==="No Conforme")?"Desaprobado":i.every(a=>a.state)?"Aprobado":"";E.useEffect(()=>{o("result",b()),o("status",b())},[i]);const R=()=>t.plate&&t.type&&t.brand&&t.model&&t.engineNumber&&t.year&&t.company&&b()&&i.every(a=>a.state),V=(a,s,r)=>{const c=i.map(l=>l.id===a?{...l,state:s!==void 0?s:l.state,observation:r}:l);S(c),o("causas",c)},H=async()=>{if(!t.plate){p.error("Por favor, ingrese una placa para buscar.");return}w(!0),p.info("Buscando información para la placa...",{duration:3e3});try{const a=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:t.plate,company_id:g})),s=await a.json();a.ok&&s.status==="success"&&s.data?(o(r=>({...r,vehicleCode:s.data.code||"",type:s.data.type||"",brand:s.data.brand||"",model:s.data.model||"",engineNumber:s.data.engine_number||"",year:s.data.year||"",company:s.company.nombre||""})),p.success("Información del vehículo cargada con éxito.")):s.status==="warning"?(p.warning(s.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),o(r=>({...r,vehicleCode:""}))):s.status==="error"?(p.error(s.message||"No se encontró información para la placa ingresada."),o(r=>({...r,vehicleCode:""}))):(p.error("No se encontró información para la placa ingresada."),o(r=>({...r,vehicleCode:""})))}catch(a){console.error(a),p.error("Ocurrió un error al buscar la placa."),o(s=>({...s,vehicleCode:""}))}finally{w(!1)}},M=async a=>{if(a.preventDefault(),!R()){p.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}O(!0);try{const s=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,causas:i,status:b()})});if(s.ok){const r=await s.json();p.success(r.message||"Reporte guardado con éxito."),T(),S(x.map(c=>({id:c.id,state:"",observation:""})))}else if(s.status===422){const r=await s.json();p.error("Errores de validación en el formulario."),console.error(r.errors)}else throw new Error("Error al guardar el reporte.")}catch(s){console.error(s),p.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{O(!1)}},K=x.reduce((a,s)=>(a[s.group]||(a[s.group]=[]),a[s.group].push(s),a),{});return e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:M,children:[e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(d,{type:"text",id:"plate",value:t.plate||"",onChange:a=>o("plate",a.target.value),className:"flex-1"}),e.jsx(B,{variant:"outline",type:"button",onClick:H,className:"flex items-center px-2",disabled:C,children:C?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(se,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(d,{type:"text",id:"vehicleCode",value:t.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(k,{value:t.type,disabled:!0,children:[e.jsx($,{className:"w-full",children:e.jsx(U,{placeholder:"Seleccione un tipo"})}),e.jsx(G,{children:ae.map(({value:a,label:s})=>e.jsx(D,{value:a,children:s},a))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(d,{type:"text",id:"brand",value:t.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(d,{type:"text",id:"model",value:t.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(d,{type:"text",id:"engineNumber",value:t.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(d,{type:"text",id:"year",value:t.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(d,{type:"text",id:"company",value:t.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(m,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(d,{type:"number",id:"mileage",value:t.mileage||"",onChange:a=>o("mileage",a.target.value),min:0,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsxs(W,{children:[e.jsx(Q,{children:e.jsxs(L,{className:"bg-muted/50 border-b",children:[e.jsx(A,{className:"h-8 border-r py-2",rowSpan:2,style:{width:"50%"},children:"Item"}),e.jsx(A,{className:"h-8 border-r py-2",colSpan:1,children:"Estado"}),e.jsx(A,{className:"h-8 border-l py-2",rowSpan:2,style:{width:"20%"},children:"Observaciones"})]})}),e.jsx(X,{children:Object.entries(K).map(([a,s])=>e.jsxs(E.Fragment,{children:[e.jsx(L,{className:"bg-muted/50",children:e.jsx(F,{colSpan:3,className:"text-center font-bold",children:a})}),s.map(r=>{var c,l;return e.jsxs(L,{children:[e.jsx(F,{className:"border-r py-1 font-medium whitespace-normal",children:r.name}),e.jsx(F,{className:"text-center",children:e.jsxs(k,{value:((c=i.find(n=>n.id===r.id))==null?void 0:c.state)||"",onValueChange:n=>{var j;return V(r.id,n,((j=i.find(I=>I.id===r.id))==null?void 0:j.observation)||"")},children:[e.jsx($,{className:"w-full",children:e.jsx(U,{placeholder:"Seleccione"})}),e.jsxs(G,{children:[e.jsx(D,{value:"Conforme",children:"Conforme"}),e.jsx(D,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(F,{children:e.jsx(d,{type:"text",value:((l=i.find(n=>n.id===r.id))==null?void 0:l.observation)||"",onChange:n=>V(r.id,void 0,n.target.value)})})]},r.id)})]},a))})]})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(ee,{images:t.images,onUpload:a=>{a.forEach(s=>{const r=new FileReader;r.onload=()=>{const c=r.result,l=new Image;l.src=c,l.onload=()=>{const n=document.createElement("canvas"),j=n.getContext("2d"),I=800,Y=I/l.width;n.width=I,n.height=l.height*Y,j==null||j.drawImage(l,0,0,n.width,n.height);const Z=n.toDataURL("image/jpeg",.8);o(_=>({..._,images:[..._.images,Z].slice(0,4)}))}},r.readAsDataURL(s)})},onRemove:a=>{const s=t.images.filter((r,c)=>c!==a);o(r=>({...r,images:s}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(m,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(d,{type:"text",id:"inspectedBy",value:f,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(m,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(d,{type:"text",id:"result",value:b(),disabled:!0,className:b()==="Desaprobado"?"text-red-600 font-bold":b()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(B,{type:"submit",className:"flex items-center",disabled:!R()||P,children:P?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})}const le=[{title:"Gestión de Formatos",href:"/format"},{title:"Inspección Vehicular Semestral",href:"/semiannual-vehicle-inspection"}],ie="semestral";function ke(){const{causas:x,auth:h}=z().props,[u,g]=v.useState(!0),f=h.user.id,N=h.user.company_id,y=h.user.name,t=h.user.company,[o,T]=v.useState(""),i=x.map(({id:S,nombre:C,group:w})=>({id:S,name:C,group:w}));return e.jsxs(re,{breadcrumbs:le,children:[e.jsx(J,{title:"Inspección Vehicular Semestral"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4",children:e.jsx(ne,{causas:i,type:ie,userId:f,companyId:N,userName:y,company:t,area:o})}),e.jsx(te,{open:u,onOpenChange:g,setArea:T})]})}export{ke as default};
