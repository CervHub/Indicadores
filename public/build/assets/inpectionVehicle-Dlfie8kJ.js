import{U as C,j as e,m as be,r as W,S as fe}from"./app-GVpGJeU7.js";import{B as E}from"./button-BHPTtTdP.js";import{I as x}from"./input-DW4r52MY.js";import{L as w}from"./label-CA0O3Swu.js";import{S as ne,a as oe,b as ie,c as le,f as Z}from"./select-ByVw2mV_.js";import{t as F}from"./index-DQ13vxLF.js";import{I as ge}from"./image-rpZXjIqa.js";import{V as je}from"./utils-qLzneZb4.js";import{T as ve,a as Ne,b as H,c as B,d as ye,e as A}from"./table-CM_elssM.js";import{D as ee,b as te,c as se,d as ae}from"./dialog-Bdq0f4Ih.js";import{D as U}from"./download-mvEW_rsI.js";import{F as G}from"./app-layout-YRmCsuoh.js";import{I as re}from"./info-VAK_x0oP.js";import{T as we}from"./triangle-alert-BlEWQfAC.js";import{S as Ce}from"./search-BeNvrx9v.js";function Se(v){const[p,b]=C.useState(v.map(o=>({id:o.id,name:o.name,state:"",observation:""}))),[S,_]=C.useState({}),[L,c]=C.useState(!1),[i,g]=C.useState([]),[M,j]=C.useState(""),[N,T]=C.useState(null);return{causaStates:p,setCausaStates:b,extraFormData:S,setExtraFormData:_,modalOpen:L,setModalOpen:c,modalAttributes:i,setModalAttributes:g,modalTitle:M,setModalTitle:j,modalCausaId:N,setModalCausaId:T}}function Fe({attributes:v,causaId:p,extraFormData:b,setExtraFormData:S,causaState:_}){const L=b[p]||{},c=(i,g,M)=>{S(j=>({...j,[p]:{...j[p],[i]:g}}))};return e.jsx("div",{className:"w-full",children:e.jsx("form",{className:`\r
                    grid grid-cols-1 gap-4\r
                    sm:grid-cols-2\r
                    md:grid-cols-2\r
                    w-full\r
                `,children:v.map(i=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(w,{children:i.name}),i.attribute_type==="fecha"&&e.jsx(x,{type:"date",value:L[i.id]||"",onChange:g=>c(i.id,g.target.value,i.name)}),i.attribute_type==="entero"&&e.jsx(x,{type:"number",value:L[i.id]||"",onChange:g=>c(i.id,g.target.value,i.name)}),i.attribute_type==="texto"&&e.jsx(x,{type:"text",value:L[i.id]||"",onChange:g=>c(i.id,g.target.value,i.name)})]},i.id))})})}function _e({causas:v,causaStates:p,setCausaStates:b,extraFormData:S,setExtraFormData:_,groupedCausas:L,modalOpen:c,setModalOpen:i,modalAttributes:g,setModalAttributes:M,modalTitle:j,setModalTitle:N,modalCausaId:T,setModalCausaId:o}){const f=d=>{const y=p.find(I=>I.id===d.id),n=(y==null?void 0:y.observation)||"",D=I=>O(d.id,void 0,I.target.value);function O(I,V,z){const $=p.map(P=>P.id===I?{...P,state:P.state,observation:z}:P);b($)}switch(d.attribute_type){case"fecha":return e.jsx(x,{type:"date",value:n,onChange:D});case"entero":return e.jsx(x,{type:"number",value:n,onChange:D});case"texto":default:return e.jsx(x,{type:"text",value:n,onChange:D})}},k=d=>{if(!d.has_attributes||!d.category_attributes)return!0;const y=S[d.id]||{};return d.category_attributes.every(n=>!!y[n.id])};return e.jsxs(e.Fragment,{children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:e.jsxs(H,{className:"bg-muted/50 border-b",children:[e.jsx(B,{className:"border-r text-center"}),e.jsx(B,{className:"border-r text-center",children:e.jsx(U,{className:"w-4 h-4 mx-auto"})}),e.jsx(B,{className:"border-r text-center sm:min-w-[400px] md:min-w-[400px] lg:min-w-[400px] xl:min-w-[800px]",children:"Causa"}),e.jsx(B,{className:"border-r text-center",children:e.jsx(G,{className:"w-4 h-4 mx-auto"})}),e.jsx(B,{className:"border-r text-center",children:"Estado"}),e.jsx(B,{className:"text-center w-[50px] md:min-w-[50px]",children:"Observaciones"})]})}),e.jsx(ye,{children:Object.entries(L).map(([d,y])=>e.jsxs(C.Fragment,{children:[e.jsx(H,{className:"bg-muted/50",children:e.jsx(A,{colSpan:6,className:"text-center font-bold border-b",children:d})}),y.map(n=>{var D;return e.jsxs(H,{className:"border-b",children:[e.jsx(A,{className:"border-r text-center",children:n.instruction?e.jsxs(ee,{children:[e.jsx(DialogTrigger,{asChild:!0,children:e.jsx(E,{type:"button",size:"icon",variant:"outline",className:"mx-0",children:e.jsx(re,{className:"w-3 h-5"})})}),e.jsxs(te,{children:[e.jsx(se,{children:e.jsx(ae,{children:"Instrucción"})}),e.jsx("div",{className:"whitespace-pre-line",children:n.instruction})]})]}):e.jsx(E,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(re,{className:"w-5 h-5"})})}),e.jsx(A,{className:"border-r text-center",children:n.document_url?e.jsx("a",{href:`/${n.document_url}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center text-blue-600",download:n.document_name||void 0,title:n.document_name||"Descargar",children:e.jsx(E,{type:"button",size:"icon",variant:"outline",className:"mx-auto",children:e.jsx(U,{className:"w-5 h-5"})})}):e.jsx(E,{type:"button",size:"icon",variant:"outline",disabled:!0,className:"mx-auto opacity-50",children:e.jsx(U,{className:"w-5 h-5"})})}),e.jsx(A,{className:"border-r font-medium whitespace-normal",children:n.nombre||n.name}),e.jsx(A,{className:"border-r text-center p-0 align-middle",children:n.has_attributes?e.jsxs(E,{type:"button",size:"icon",variant:"ghost",className:"mx-auto p-0 h-8 w-8 relative",onClick:()=>{M(n.category_attributes||[]),N(n.nombre||n.name||""),o(n.id),i(!0)},children:[e.jsx(G,{className:"w-4 h-4"}),!k(n)&&e.jsx("span",{className:"absolute top-0 right-0 flex items-center animate-pulse",children:e.jsx(we,{className:"w-4 h-4 text-yellow-900 drop-shadow-[0_0_4px_rgba(255,193,7,0.8)]"})})]}):e.jsx(E,{type:"button",size:"icon",variant:"ghost",disabled:!0,className:"mx-auto opacity-50 p-0 h-8 w-8",children:e.jsx(G,{className:"w-4 h-4"})})}),e.jsx(A,{className:"border-r text-center",children:e.jsxs(ne,{value:((D=p.find(O=>O.id===n.id))==null?void 0:D.state)||"",onValueChange:O=>b(I=>I.map(V=>V.id===n.id?{...V,state:O}:V)),children:[e.jsx(oe,{className:"w-full",children:e.jsx(ie,{placeholder:"Seleccione"})}),e.jsxs(le,{children:[e.jsx(Z,{value:"Conforme",children:"Conforme"}),e.jsx(Z,{value:"No Conforme",children:"No Conforme"})]})]})}),e.jsx(A,{children:f(n)})]},n.id)})]},d))})]}),e.jsx(ee,{open:c,onOpenChange:d=>{i(d),d||o(null)},children:e.jsxs(te,{children:[e.jsx(se,{children:e.jsx(ae,{children:j})}),T&&e.jsx(Fe,{attributes:g,causaId:T,extraFormData:S,setExtraFormData:_,causaState:p.find(d=>d.id===T)})]})})]})}function Le(){const p=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),b=S=>{var _;return(_=p.find(L=>L.type===S))==null?void 0:_.value};return`${b("year")}-${b("month")}-${b("day")}T${b("hour")}:${b("minute")}`}function Ge({causas:v,type:p,userId:b,companyId:S,userName:_,company:L,area:c}){const i=v.filter(s=>{var t,a,r,u,l;return!((t=s.name)!=null&&t.toLowerCase().startsWith("neumáticos"))&&!((a=s.name)!=null&&a.toLowerCase().includes("grúa"))&&!((r=s.name)!=null&&r.toLowerCase().includes("grua"))&&!((u=s.name)!=null&&u.toLowerCase().includes("banderín"))&&!((l=s.name)!=null&&l.toLowerCase().includes("banderin"))}),g=v.filter(s=>{var t;return(t=s.name)==null?void 0:t.toLowerCase().startsWith("neumáticos")}),M=v.filter(s=>{var t,a;return((t=s.name)==null?void 0:t.toLowerCase().includes("grúa"))||((a=s.name)==null?void 0:a.toLowerCase().includes("grua"))}),j=v.filter(s=>{var t,a;return((t=s.name)==null?void 0:t.toLowerCase().includes("banderín"))||((a=s.name)==null?void 0:a.toLowerCase().includes("banderin"))}),[N,T]=C.useState(()=>{let s=[...i];if((c==null?void 0:c.toLowerCase())==="mina"){const t=j.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("rojo")});t&&s.push(t)}else{const t=j.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("verde")});t&&s.push(t)}return s});C.useEffect(()=>{let s=[...i];if((c==null?void 0:c.toLowerCase())==="mina"){const t=j.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("rojo")});t&&s.push(t)}else{const t=j.find(a=>{var r;return(r=a.name)==null?void 0:r.toLowerCase().includes("verde")});t&&s.push(t)}T(s)},[c]);const{data:o,setData:f,reset:k}=be({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",mileage:"",company:"",driver:"",licenseNumber:"",generalState:"",vehicleCode:"",images:[],signature:"",result:"",inspectionDate:Le(),companyId:S,userId:b,userName:_,type_report:"vehicular",type_inspection:p,causas:i.map(s=>({id:s.id,name:s.name,state:"",observation:""})),status:"",area:c}),{causaStates:d,setCausaStates:y,extraFormData:n,setExtraFormData:D,modalOpen:O,setModalOpen:I,modalAttributes:V,setModalAttributes:z,modalTitle:$,setModalTitle:P,modalCausaId:de,setModalCausaId:ce}=Se(N);C.useEffect(()=>{y(s=>N.map(a=>{const r=s.find(u=>u.id===a.id);return r||{id:a.id,name:a.name,state:"",observation:""}})),D(s=>{const t={...s};return N.forEach(a=>{a.id in t||(t[a.id]={})}),Object.keys(t).forEach(a=>{N.some(r=>String(r.id)===String(a))||delete t[a]}),t})},[N,y,D]),C.useEffect(()=>{f(s=>({...s,area:c}))},[c]);const[q,J]=W.useState(!1),[De,Ie]=W.useState(!1),[K,Y]=W.useState(!1),R=()=>d.some(s=>s.state==="No Conforme")?"Desaprobado":d.every(s=>s.state)?"Aprobado":"";C.useEffect(()=>{f("result",R()),f("status",R())},[d]);const Q=()=>{const s=N.every(t=>{if(!t.has_attributes||!t.category_attributes)return!0;const a=n[t.id]||{};return t.category_attributes.every(r=>!!a[r.id])});return o.plate&&o.type&&o.brand&&o.model&&o.engineNumber&&o.year&&o.company&&R()&&d.every(t=>t.state)&&s},me=async()=>{if(!o.plate){F.error("Por favor, ingrese una placa para buscar.");return}J(!0),F.info("Buscando información para la placa...",{duration:3e3});try{const s=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:o.plate,company_id:S})),t=await s.json();if(s.ok&&t.status==="success"&&t.data){f(l=>({...l,vehicleCode:t.data.code||"",type:t.data.type||"",brand:t.data.brand||"",model:t.data.model||"",engineNumber:t.data.engine_number||"",year:t.data.year||"",company:t.company.nombre||""}));let a=[...i];if((c==null?void 0:c.toLowerCase())==="mina"){const l=j.find(h=>{var m;return(m=h.name)==null?void 0:m.toLowerCase().includes("rojo")});l&&a.push(l)}else{const l=j.find(h=>{var m;return(m=h.name)==null?void 0:m.toLowerCase().includes("verde")});l&&a.push(l)}const r=t.data.tire_count;if(r){const l=`Neumáticos ${Number(r)}`,h=g.find(m=>m.name===l);h&&!a.some(m=>m.id===h.id)&&(a=[...a,h])}const u=(t.data.type||"").toLowerCase();(u.includes("grúa")||u.includes("grua"))&&M.forEach(l=>{a.some(h=>h.id===l.id)||a.push(l)}),T(a),F.success("Información del vehículo cargada con éxito.")}else t.status==="warning"?(F.warning(t.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),f(a=>({...a,vehicleCode:""}))):t.status==="error"?(F.error(t.message||"No se encontró información para la placa ingresada."),f(a=>({...a,vehicleCode:""}))):(F.error("No se encontró información para la placa ingresada."),f(a=>({...a,vehicleCode:""})))}catch(s){console.error(s),F.error("Ocurrió un error al buscar la placa."),f(t=>({...t,vehicleCode:""}))}finally{J(!1)}},ue=async s=>{if(s.preventDefault(),!Q()){F.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}Y(!0);try{const t=d.map(r=>{const u=n[r.id]||{};let l=[];const h=v.find(m=>m.id===r.id);return h&&h.category_attributes&&(l=h.category_attributes.map(m=>({id:m.id,value:u[m.id]??"",name:m.name}))),{...r,extraForm:l}}),a=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...o,causas:t,status:R()})});if(a.ok){const r=await a.json();F.success(r.message||"Reporte guardado con éxito."),k(),y(v.map(u=>({id:u.id,state:"",observation:""}))),fe.visit(route("admin.reportability"))}else if(a.status===422){const r=await a.json();F.error("Errores de validación en el formulario."),console.error(r.errors)}else throw new Error("Error al guardar el reporte.")}catch(t){console.error(t),F.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{Y(!1)}},he=N.reduce((s,t)=>(s[t.group]||(s[t.group]=[]),s[t.group].push(t),s),{});return e.jsx(e.Fragment,{children:e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:ue,children:[e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(x,{type:"text",id:"plate",value:o.plate||"",onChange:s=>f("plate",s.target.value),className:"flex-1"}),e.jsx(E,{variant:"outline",type:"button",onClick:me,className:"flex items-center px-2",disabled:q,children:q?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(Ce,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"vehicleCode",className:"mb-3",children:"Código de llamada"}),e.jsx(x,{type:"text",id:"vehicleCode",value:o.vehicleCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(ne,{value:o.type,disabled:!0,children:[e.jsx(oe,{className:"w-full",children:e.jsx(ie,{placeholder:"Seleccione un tipo"})}),e.jsx(le,{children:je.map(({value:s,label:t})=>e.jsx(Z,{value:s,children:t},s))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(x,{type:"text",id:"brand",value:o.brand||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(x,{type:"text",id:"model",value:o.model||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(x,{type:"text",id:"engineNumber",value:o.engineNumber||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(x,{type:"text",id:"year",value:o.year||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(x,{type:"text",id:"company",value:o.company||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(w,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(x,{type:"number",id:"mileage",value:o.mileage||"",onChange:s=>{const t=s.target.value.replace(/\D/g,"").slice(0,7);f("mileage",t)},min:0,max:9999999,placeholder:"Ingrese el kilometraje"})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsx(_e,{causas:N,causaStates:d,setCausaStates:y,extraFormData:n,setExtraFormData:D,groupedCausas:he,modalOpen:O,setModalOpen:I,modalAttributes:V,setModalAttributes:z,modalTitle:$,setModalTitle:P,modalCausaId:de,setModalCausaId:ce})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(ge,{images:o.images,onUpload:s=>{s.forEach(t=>{const a=new FileReader;a.onload=()=>{const r=a.result,u=new Image;u.src=r,u.onload=()=>{const l=document.createElement("canvas"),h=l.getContext("2d"),m=800,xe=m/u.width;l.width=m,l.height=u.height*xe,h==null||h.drawImage(u,0,0,l.width,l.height);const pe=l.toDataURL("image/jpeg",.8);f(X=>({...X,images:[...X.images,pe].slice(0,4)}))}},a.readAsDataURL(t)})},onRemove:s=>{const t=o.images.filter((a,r)=>r!==s);f(a=>({...a,images:t}))},label:"Imágenes adicionales"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(w,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(x,{type:"text",id:"inspectedBy",value:_,disabled:!0})]}),e.jsxs("div",{className:"flex flex-col justify-center h-full",children:[e.jsx(w,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsx(x,{type:"text",id:"result",value:R(),disabled:!0,className:R()==="Desaprobado"?"text-red-600 font-bold":R()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(E,{type:"submit",className:"flex items-center",disabled:!Q()||K,children:K?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})})}export{Ge as I};
