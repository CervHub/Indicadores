import{r as x,U as y,j as e,K as O,L as $}from"./app-GVpGJeU7.js";import{B as I}from"./button-BHPTtTdP.js";import{I as f}from"./input-DW4r52MY.js";import{L as h}from"./label-CA0O3Swu.js";import{S as _,a as k,b as B,c as R,f as D}from"./select-ByVw2mV_.js";import{T as H,a as q,b as E,c as F,d as G,e as V}from"./table-CM_elssM.js";import{T as K}from"./textarea-pyJOf_9Q.js";import{t as i}from"./index-DQ13vxLF.js";import{S as U}from"./search-BeNvrx9v.js";import{A as J}from"./app-layout-YRmCsuoh.js";import Z from"./statement-D1Pjk022.js";import"./utils-qLzneZb4.js";import"./index-CZ6M3Ocn.js";import"./index-CwCzXZA7.js";import"./index-Bj6WAKAy.js";import"./index-n7sBKrK3.js";import"./createLucideIcon-CFMFBQne.js";import"./index-Ro_MRc18.js";import"./index-CU00uo7P.js";import"./check-ohEls-Zn.js";import"./tooltip-DUgacRix.js";import"./chevrons-up-down-R3NTjYK1.js";import"./truck-BgLGUDVY.js";import"./chevron-right-y3yTp_Zd.js";import"./dialog-Bdq0f4Ih.js";function C(){const c=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(new Date),n=u=>{var d;return(d=c.find(t=>t.type===u))==null?void 0:d.value};return`${n("year")}-${n("month")}-${n("day")}T${n("hour")}:${n("minute")}:${n("second")}`}function z({causas:p,companyId:c,userId:n,userName:u,area:d}){const[t,r]=x.useState({plate:"",vehicleCode:"",department:"",shift:C(),driver:u,mileage:"",images:[],signature:"",observation:"",causas:p.map(s=>({id:s.id,state:""})),companyId:c,userId:n,userName:u,type_report:"vehicular",type_inspection:"pre-use",status:"",area:d});y.useEffect(()=>{r(s=>({...s,area:d}))},[d]);const[j,N]=x.useState(!1),[l,v]=x.useState({}),[S,w]=x.useState(!1),T=()=>{const s=t.causas.every(a=>a.state!=="");return t.plate&&t.vehicleCode&&t.department&&t.shift&&t.mileage&&s},P=(s,a)=>{const o=p.find(m=>m.id===s);r(m=>({...m,causas:m.causas.map(g=>g.id===s?{...g,state:a,item:(o==null?void 0:o.name)||""}:g)}))},L=async()=>{if(!t.plate){i.error("Por favor, ingrese una placa para buscar.");return}w(!0),i.info("Buscando información para la placa...",{duration:3e3});try{const s=await fetch(route("web.v1.searchVehiclesForInspection",{license_plate:t.plate,company_id:c})),a=await s.json();s.ok&&a.status==="success"&&a.data?(r(o=>({...o,vehicleCode:a.data.code||"",department:a.company.nombre||""})),i.success("Información del vehículo cargada con éxito.")):a.status==="warning"?(i.warning(a.message||"El vehículo no está vinculado a la empresa seleccionada.",{duration:1e4}),r(o=>({...o,vehicleCode:""}))):a.status==="error"?(i.error(a.message||"No se encontró información para la placa ingresada."),r(o=>({...o,vehicleCode:""}))):(i.error("No se encontró información para la placa ingresada."),r(o=>({...o,vehicleCode:""})))}catch(s){console.error(s),i.error("Ocurrió un error al buscar la placa."),r(a=>({...a,vehicleCode:""}))}finally{w(!1)}},b=()=>t.causas.every(a=>a.state!=="")?t.causas.some(a=>a.state==="No Conforme")?"Desaprobado":"Aprobado":"";y.useEffect(()=>{const s=b();r(a=>({...a,status:s}))},[t.causas]),y.useEffect(()=>{const s=setInterval(()=>{r(a=>({...a,shift:C()}))},1e3);return()=>clearInterval(s)},[]);const A=async s=>{if(s.preventDefault(),!T()){i.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}N(!0),v({});try{const a=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,status:b()})});if(!a.ok){if(a.status===422){const m=await a.json();v(m.errors||{})}throw new Error("Error al enviar el formulario.")}const o=await a.json();i.success(o.message||"Reporte generado con éxito."),r(m=>({...m,plate:"",vehicleCode:"",department:"",shift:C(),driver:u,mileage:"",images:[],signature:"",observation:"",causas:p.map(g=>({id:g.id,state:""}))}))}catch(a){console.error(a),i.error("Ocurrió un error al enviar el formulario. Intente de nuevo.")}finally{N(!1)}};return e.jsxs("form",{className:"grid grid-cols-4 gap-6 md:grid-cols-4 lg:grid-cols-5",onSubmit:A,children:[e.jsxs("div",{className:"col-span-4 flex items-end gap-2 md:col-span-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(h,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsx(f,{type:"text",id:"plate",value:t.plate,onChange:s=>r(a=>({...a,plate:s.target.value}))}),l.plate&&e.jsx("p",{className:"text-sm text-red-500",children:l.plate})]}),e.jsx(I,{type:"button",variant:"outline",onClick:L,className:"mt-6 h-10",disabled:S,children:S?e.jsx("span",{className:"loader h-4 w-4 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(U,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(h,{htmlFor:"vehicle-code",className:"mb-3",children:"Código de Llamada"}),e.jsx(f,{disabled:!0,type:"text",id:"vehicle-code",value:t.vehicleCode,onChange:s=>r(a=>({...a,vehicleCode:s.target.value}))}),l.vehicleCode&&e.jsx("p",{className:"text-sm text-red-500",children:l.vehicleCode})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(h,{htmlFor:"department",className:"mb-3",children:"Empresa"}),e.jsx(f,{disabled:!0,type:"text",id:"department",value:t.department,onChange:s=>r(a=>({...a,department:s.target.value}))}),l.department&&e.jsx("p",{className:"text-sm text-red-500",children:l.department})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(h,{htmlFor:"shift",className:"mb-3",children:"Hora actual"}),e.jsx(f,{id:"shift",type:"datetime-local",value:t.shift,disabled:!0})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(h,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(f,{type:"number",id:"mileage",value:t.mileage,onChange:s=>r(a=>({...a,mileage:s.target.value}))}),l.mileage&&e.jsx("p",{className:"text-sm text-red-500",children:l.mileage})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background rounded-md border",children:e.jsxs(H,{children:[e.jsx(q,{children:e.jsxs(E,{className:"bg-muted/50 border-b",children:[e.jsx(F,{className:"h-9 w-9/10 border-r py-2",children:"Item"}),e.jsx(F,{className:"h-9 w-1/10 py-2",children:"Estado"})]})}),e.jsx(G,{children:p.map(s=>{var a;return e.jsxs(E,{children:[e.jsx(V,{className:"border-r py-2 font-medium whitespace-normal",children:s.name}),e.jsx(V,{className:"text-center",children:e.jsxs(_,{value:((a=t.causas.find(o=>o.id===s.id))==null?void 0:a.state)||"",onValueChange:o=>P(s.id,o),children:[e.jsx(k,{children:e.jsx(B,{placeholder:"Seleccione estado"})}),e.jsxs(R,{children:[e.jsx(D,{value:"Conforme",children:"Conforme"}),e.jsx(D,{value:"No Conforme",children:"No Conforme"})]})]})})]},s.id)})})]})})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx(h,{htmlFor:"observation",className:"mb-3",children:"Observaciones"}),e.jsx(K,{id:"observation",value:t.observation,onChange:s=>r(a=>({...a,observation:s.target.value})),placeholder:"Escriba sus observaciones aquí..."}),l.observation&&e.jsx("p",{className:"text-sm text-red-500",children:l.observation})]}),e.jsxs("div",{className:"col-span-auto",children:[e.jsx(h,{htmlFor:"status",className:"mb-3",children:"Estado final"}),e.jsx(f,{id:"status",value:b(),disabled:!0,className:b()==="Desaprobado"?"text-red-600 font-bold":b()==="Aprobado"?"text-green-600 font-bold":""})]}),e.jsx("br",{}),e.jsx("div",{className:"col-span-4",children:e.jsx(I,{type:"submit",className:"flex-start",disabled:!T()||j,children:j?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):"Generar reporte"})})]})}const M=[{title:"Gestión de Formatos",href:"/format"},{title:"Inspección Vehicular Diaria",href:"/daily-vehicle-inspection"}];function Ne(){const{causas:p,auth:c}=O().props,[n,u]=x.useState(!0),[d,t]=x.useState(""),r=c.user.id,j=c.user.company_id,N=c.user.name,l=p.map(v=>({id:v.id,name:v.nombre}));return e.jsxs(J,{breadcrumbs:M,children:[e.jsx($,{title:"Inspección Vehicular Diaria"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4",children:e.jsx(z,{causas:l,userId:r,userName:N,companyId:j,area:d})}),e.jsx(Z,{open:n,onOpenChange:u,setArea:t})]})}export{Ne as default};
