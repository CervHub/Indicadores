import{m as K,r as f,j as e,U as Q}from"./app-CEM5Qn-0.js";import{B as F}from"./button-B0AYnjnb.js";import{I as h}from"./input-D7D8xCxK.js";import{L as c}from"./label-BytpaINN.js";import{S as P,a as U,b as M,c as V,f as D}from"./select-Cqes-gWR.js";import{T as X,a as Y,b as y,c as g,d as ee,e as b}from"./table-BXfsTLSy.js";import{t as d}from"./index-C9OkIrbf.js";import{I as _}from"./image-C3E2lCDX.js";import{S as H}from"./search-DIZc7Xs5.js";function ae(){const w=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),p=S=>{var v;return(v=w.find(T=>T.type===S))==null?void 0:v.value};return`${p("year")}-${p("month")}-${p("day")}T${p("hour")}:${p("minute")}`}const re={camioneta:"Camioneta",combi:"Combi",ambulancia:"Ambulancia",bus:"Bus",camión:"Camión","camión grúa":"Camión Grúa",otros:"Otros"};function he({causas:j,type:w,userId:p,companyId:S,userName:v,company:T}){const{data:s,setData:n,reset:z}=K({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",company:"",driver:"",licenseNumber:"",generalState:"",autoGeneratedCode:"",images:[],signature:"",result:"",inspectionDate:ae(),companyId:S,userId:p,userName:v,type_report:"vehicular",type_inspection:w,causas:j.map(a=>({id:a.id,state:"",observation:""}))}),[x,E]=f.useState(j.map(a=>({id:a.id,state:"",observation:""}))),[B,A]=f.useState(!1),[R,L]=f.useState(!1),[k,$]=f.useState(!1),G=()=>s.plate&&s.type&&s.brand&&s.model&&s.engineNumber&&s.year&&s.company&&s.driver&&s.licenseNumber&&s.generalState&&s.result&&s.inspectionDate,N=(a,r,t)=>{const i=x.map(l=>l.id===a?{...l,state:r||l.state,observation:t}:l);E(i),n("causas",i)},W=()=>{if(!s.plate){d.error("Por favor, ingrese una placa para buscar.");return}A(!0),d.info("Buscando información para la placa...",{duration:3e3}),fetch(route("web.v1.searchVehicles",{plate:s.plate})).then(a=>{if(!a.ok)throw new Error("Error al buscar la placa.");return a.json()}).then(a=>{const r=a.data;r?(n("brand",r.brand||""),n("engineNumber",r.engine_number||""),n("autoGeneratedCode",r.code||""),n("year",r.year||""),n("model",r.model||""),n("type",r.type||""),d.success("Información del vehículo cargada con éxito.")):d.error("No se encontró información para la placa ingresada.")}).catch(a=>{console.error(a),d.error("Ocurrió un error al buscar la placa.")}).finally(()=>{A(!1)})},Z=()=>{if(!s.licenseNumber){d.error("Por favor, ingrese un número de licencia para buscar.");return}L(!0),d.info("Buscando información para el número de licencia...",{duration:3e3}),fetch(route("web.v1.searchUsers",{licenseNumber:s.licenseNumber})).then(a=>{if(!a.ok)throw new Error("Error al buscar el número de licencia.");return a.json()}).then(a=>{const r=a.data;r?(n("driver",`${r.nombres} ${r.apellidos}`),n("company",r.empresa||""),d.success("Información del usuario cargada con éxito.")):d.error("No se encontró información para el número de licencia ingresado.")}).catch(a=>{console.error(a),d.error("Ocurrió un error al buscar el número de licencia.")}).finally(()=>{L(!1)})},q=async a=>{if(a.preventDefault(),!G()){d.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}$(!0);try{const r=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...s,causas:x})});if(r.ok){const t=await r.json();d.success(t.message||"Reporte guardado con éxito."),z(),E(j.map(i=>({id:i.id,state:"",observation:""})))}else if(r.status===422){const t=await r.json();d.error("Errores de validación en el formulario."),console.error(t.errors)}else throw new Error("Error al guardar el reporte.")}catch(r){console.error(r),d.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{$(!1)}},J=j.reduce((a,r)=>(a[r.group]||(a[r.group]=[]),a[r.group].push(r),a),{});return e.jsxs("form",{className:"grid grid-cols-2 gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5",onSubmit:q,children:[e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(h,{type:"text",id:"plate",value:s.plate||"",onChange:a=>n("plate",a.target.value),className:"flex-1"}),e.jsx(F,{variant:"outline",type:"button",onClick:W,className:"flex items-center px-2",disabled:B,children:B?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(H,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(P,{onValueChange:a=>n("type",a),value:s.type,children:[e.jsx(U,{className:"w-full",children:e.jsx(M,{placeholder:"Seleccione un tipo"})}),e.jsx(V,{children:Object.entries(re).map(([a,r])=>e.jsx(D,{value:r,children:r},r))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(h,{type:"text",id:"brand",value:s.brand||"",onChange:a=>n("brand",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(h,{type:"text",id:"model",value:s.model||"",onChange:a=>n("model",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(h,{type:"text",id:"engineNumber",value:s.engineNumber||"",onChange:a=>n("engineNumber",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(h,{type:"text",id:"year",value:s.year||"",onChange:a=>n("year",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"autoGeneratedCode",className:"mb-3",children:"Código Autogenerado"}),e.jsx(h,{type:"text",id:"autoGeneratedCode",value:s.autoGeneratedCode||"",disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"generalState",className:"mb-3",children:"Estado General del Vehículo"}),e.jsx(h,{type:"text",id:"generalState",value:s.generalState||"",onChange:a=>n("generalState",a.target.value)})]}),e.jsx("div",{className:"",children:e.jsxs("div",{className:"flex-1",children:[e.jsx(c,{htmlFor:"licenseNumber",className:"mb-3",children:"Nº Licencia"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(h,{type:"text",id:"licenseNumber",value:s.licenseNumber||"",onChange:a=>n("licenseNumber",a.target.value),className:"flex-1"}),e.jsx(F,{variant:"outline",type:"button",onClick:Z,className:"flex items-center px-2",disabled:R,children:R?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(H,{className:"h-5 w-5 text-gray-500"})})]})]})}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"driver",className:"mb-3",children:"Conductor"}),e.jsx(h,{type:"text",id:"driver",value:s.driver||"",onChange:a=>n("driver",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(h,{type:"text",id:"company",value:s.company||"",onChange:a=>n("company",a.target.value)})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsxs(X,{children:[e.jsxs(Y,{children:[e.jsxs(y,{className:"bg-muted/50 border-b",children:[e.jsx(g,{className:"h-8 border-r py-2",rowSpan:2,style:{width:"50%"},children:"Item"}),e.jsx(g,{className:"h-8 border-r py-2",colSpan:3,children:"Estado"}),e.jsx(g,{className:"h-8 border-l py-2",rowSpan:2,style:{width:"20%"},children:"Observaciones"})]}),e.jsxs(y,{className:"bg-muted/50 border-b",children:[e.jsx(g,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Bien"}),e.jsx(g,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Mal"}),e.jsx(g,{className:"h-8 py-2",style:{width:"10%"},children:"No Aplica"})]})]}),e.jsx(ee,{children:Object.entries(J).map(([a,r])=>e.jsxs(Q.Fragment,{children:[e.jsx(y,{className:"bg-muted/50",children:e.jsx(b,{colSpan:5,className:"text-center font-bold",children:a})}),r.map(t=>{var i,l,m,u;return e.jsxs(y,{children:[e.jsx(b,{className:"border-r py-1 font-medium whitespace-normal",children:t.name}),e.jsx(b,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"Bien",checked:((i=x.find(o=>o.id===t.id))==null?void 0:i.state)==="Bien",onChange:()=>N(t.id,"Bien","")})}),e.jsx(b,{className:"border-r border-l text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"Mal",checked:((l=x.find(o=>o.id===t.id))==null?void 0:l.state)==="Mal",onChange:()=>N(t.id,"Mal","")})}),e.jsx(b,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"No Aplica",checked:((m=x.find(o=>o.id===t.id))==null?void 0:m.state)==="No Aplica",onChange:()=>N(t.id,"No Aplica","")})}),e.jsx(b,{children:e.jsx(h,{type:"text",value:((u=x.find(o=>o.id===t.id))==null?void 0:u.observation)||"",onChange:o=>N(t.id,"",o.target.value)})})]},t.id)})]},a))})]})})]}),e.jsx("div",{className:"col-span-full",children:e.jsx(_,{images:s.images,onUpload:a=>{a.forEach(r=>{const t=new FileReader;t.onload=()=>{const i=t.result,l=new Image;l.src=i,l.onload=()=>{const m=document.createElement("canvas"),u=m.getContext("2d"),o=800,C=o/l.width;m.width=o,m.height=l.height*C,u==null||u.drawImage(l,0,0,m.width,m.height);const I=m.toDataURL("image/jpeg",.8);n(O=>({...O,images:[...O.images,I].slice(0,4)}))}},t.readAsDataURL(r)})},onRemove:a=>{const r=s.images.filter((t,i)=>i!==a);n(t=>({...t,images:r}))},label:"Imágenes adicionales"})}),e.jsx("div",{className:"col-span-full",children:e.jsx(_,{images:s.signature?[s.signature]:[],maxImages:1,onUpload:a=>{const r=new FileReader;r.onload=()=>{const t=r.result,i=new Image;i.src=t,i.onload=()=>{const l=document.createElement("canvas"),m=l.getContext("2d"),u=800,o=u/i.width;l.width=u,l.height=i.height*o,m==null||m.drawImage(i,0,0,l.width,l.height);const C=l.toDataURL("image/jpeg",.8);n(I=>({...I,signature:C}))}},r.readAsDataURL(a[0])},onRemove:()=>n(a=>({...a,signature:""})),label:"Firma"})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(c,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(h,{type:"text",id:"inspectedBy",value:v,disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"inspectionDate",className:"mb-3",children:"Fecha y Hora de Inspección"}),e.jsx(h,{type:"datetime-local",id:"inspectionDate",value:s.inspectionDate||"",onChange:a=>n("inspectionDate",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsxs(P,{onValueChange:a=>n("result",a),value:s.result,children:[e.jsx(U,{className:"w-full",children:e.jsx(M,{placeholder:"Seleccione el resultado"})}),e.jsxs(V,{children:[e.jsx(D,{value:"Aprobado",children:"Aprobado"}),e.jsx(D,{value:"Desaprobado",children:"Desaprobado"})]})]})]}),e.jsx("div",{className:"col-span-full flex",children:e.jsx(F,{type:"submit",className:"flex items-center",disabled:!G()||k,children:k?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})}export{he as I};
