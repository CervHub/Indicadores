import{r as N,j as e,K as U,L as M}from"./app-CEM5Qn-0.js";import{B}from"./button-B0AYnjnb.js";import{I as x}from"./input-D7D8xCxK.js";import{L as m}from"./label-BytpaINN.js";import{S as O,a as _,b as q,c as z,f as I}from"./select-Cqes-gWR.js";import{T as G,a as H,b as T,c as b,d as K,e as y}from"./table-BXfsTLSy.js";import{T as W}from"./textarea-vzsC3_xf.js";import{t as h}from"./index-C9OkIrbf.js";import{I as P}from"./image-C3E2lCDX.js";import{S as Z}from"./search-DIZc7Xs5.js";import{A as J}from"./app-layout-8ZfYVQXB.js";import"./index-mVPaEHb-.js";import"./utils-B6AGoeaF.js";import"./index-U-sSqqFp.js";import"./index-CGiTrI50.js";import"./index-DLtaw3MY.js";import"./index-DnvTe-9K.js";import"./check-C60Q1oqJ.js";import"./index-D8ySJul5.js";import"./index-BYoQePCx.js";import"./chevrons-up-down-zyqqB-Uf.js";import"./truck-QvbEGBTl.js";import"./chevron-right-CtiaDQAh.js";function V(){const p=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Lima",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),d=u=>{var r;return(r=p.find(o=>o.type===u))==null?void 0:r.value};return`${d("year")}-${d("month")}-${d("day")}T${d("hour")}:${d("minute")}`}function Q({causas:g,companyId:p,userId:d,userName:u}){const[r,o]=N.useState({plate:"",vehicleCode:"",department:"",date:V(),shift:"",driver:u,mileage:"",recordNumber:"",images:[],signature:"",observations:"",causas:g.map(a=>({id:a.id,state:""})),companyId:p,userId:d,userName:u,type_report:"vehicular",type_inspection:"pre-use"}),[j,D]=N.useState(!1),[l,F]=N.useState({}),[R,E]=N.useState(!1),L=()=>{const a=r.causas.every(s=>s.state!=="");return r.plate&&r.vehicleCode&&r.department&&r.date&&r.shift&&r.driver&&r.mileage&&r.recordNumber&&a&&r.signature},w=(a,s)=>{o(i=>({...i,causas:i.causas.map(t=>t.id===a?{...t,state:s}:t)}))},$=async()=>{if(!r.plate){h.error("Por favor, ingrese una placa para buscar.");return}E(!0),h.info("Buscando información para la placa...",{duration:3e3});try{const a=await fetch(route("web.v1.searchVehicles",{plate:r.plate}));if(!a.ok)throw new Error("Error al buscar la placa.");const i=(await a.json()).data;i?(o(t=>({...t,vehicleCode:i.code||""})),h.success("Información del vehículo cargada con éxito.")):h.error("No se encontró información para la placa ingresada.")}catch(a){console.error(a),h.error("Ocurrió un error al buscar la placa.")}finally{E(!1)}},k=async a=>{if(a.preventDefault(),!L()){h.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}D(!0),F({});try{const s=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok){if(s.status===422){const t=await s.json();F(t.errors||{})}throw new Error("Error al enviar el formulario.")}const i=await s.json();h.success(i.message||"Reporte generado con éxito."),o(t=>({...t,plate:"",vehicleCode:"",department:"",date:V(),shift:"",driver:u,mileage:"",recordNumber:"",images:[],signature:"",observations:"",causas:g.map(n=>({id:n.id,state:""}))}))}catch(s){console.error(s),h.error("Ocurrió un error al enviar el formulario. Intente de nuevo.")}finally{D(!1)}};return e.jsxs("form",{className:"grid grid-cols-1 gap-6 md:grid-cols-4",onSubmit:k,children:[e.jsxs("div",{className:"col-span-4 flex items-end gap-2 md:col-span-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(m,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsx(x,{type:"text",id:"plate",value:r.plate,onChange:a=>o(s=>({...s,plate:a.target.value}))}),l.plate&&e.jsx("p",{className:"text-sm text-red-500",children:l.plate})]}),e.jsx(B,{type:"button",variant:"outline",onClick:$,className:"mt-6 h-10",disabled:R,children:R?e.jsx("span",{className:"loader h-4 w-4 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(m,{htmlFor:"vehicle-code",className:"mb-3",children:"Código de vehículo"}),e.jsx(x,{readOnly:!0,type:"text",id:"vehicle-code",value:r.vehicleCode,onChange:a=>o(s=>({...s,vehicleCode:a.target.value}))}),l.vehicleCode&&e.jsx("p",{className:"text-sm text-red-500",children:l.vehicleCode})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(m,{htmlFor:"department",className:"mb-3",children:"Dpto/Sección"}),e.jsx(x,{type:"text",id:"department",value:r.department,onChange:a=>o(s=>({...s,department:a.target.value}))}),l.department&&e.jsx("p",{className:"text-sm text-red-500",children:l.department})]}),e.jsxs("div",{className:"col-span-4 md:col-span-1",children:[e.jsx(m,{htmlFor:"date",className:"mb-3",children:"Fecha"}),e.jsx(x,{type:"datetime-local",id:"date",value:r.date,onChange:a=>o(s=>({...s,date:a.target.value}))}),l.date&&e.jsx("p",{className:"text-sm text-red-500",children:l.date})]}),e.jsxs("div",{className:"col-span-4 md:col-span-1",children:[e.jsx(m,{htmlFor:"shift",className:"mb-3",children:"Turno"}),e.jsxs(O,{onValueChange:a=>o(s=>({...s,shift:a})),value:r.shift,children:[e.jsx(_,{children:e.jsx(q,{placeholder:"Seleccione un turno"})}),e.jsxs(z,{children:[e.jsx(I,{value:"Mañana",children:"Mañana"}),e.jsx(I,{value:"Tarde",children:"Tarde"}),e.jsx(I,{value:"Noche",children:"Noche"})]})]}),l.shift&&e.jsx("p",{className:"text-sm text-red-500",children:l.shift})]}),e.jsxs("div",{className:"col-span-4 md:col-span-1",children:[e.jsx(m,{htmlFor:"driver",className:"mb-3",children:"Conductor"}),e.jsx(x,{type:"text",id:"driver",value:r.driver,onChange:a=>o(s=>({...s,driver:a.target.value}))}),l.driver&&e.jsx("p",{className:"text-sm text-red-500",children:l.driver})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(m,{htmlFor:"mileage",className:"mb-3",children:"Kilometraje"}),e.jsx(x,{type:"number",id:"mileage",value:r.mileage,onChange:a=>o(s=>({...s,mileage:a.target.value}))}),l.mileage&&e.jsx("p",{className:"text-sm text-red-500",children:l.mileage})]}),e.jsxs("div",{className:"col-span-2 md:col-span-1",children:[e.jsx(m,{htmlFor:"record-number",className:"mb-3",children:"Registro N°"}),e.jsx(x,{type:"text",id:"record-number",value:r.recordNumber,onChange:a=>o(s=>({...s,recordNumber:a.target.value}))}),l.recordNumber&&e.jsx("p",{className:"text-sm text-red-500",children:l.recordNumber})]}),e.jsxs("div",{className:"col-span-4",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background rounded-md border",children:e.jsxs(G,{children:[e.jsxs(H,{children:[e.jsxs(T,{className:"bg-muted/50 border-b",children:[e.jsx(b,{className:"h-9 w-7/10 border-r py-2",rowSpan:2,children:"Item"}),e.jsx(b,{className:"h-9 border-r py-2",colSpan:3,children:"Estado"})]}),e.jsxs(T,{className:"bg-muted/50 border-b",children:[e.jsx(b,{className:"h-9 w-1/10 border-r py-2",children:"Bien"}),e.jsx(b,{className:"h-9 w-1/10 border-r py-2",children:"Mal"}),e.jsx(b,{className:"h-9 w-1/10 py-2",children:"No Aplica"})]})]}),e.jsx(K,{children:g.map(a=>{var s,i,t;return e.jsxs(T,{children:[e.jsx(y,{className:"border-r py-2 font-medium whitespace-normal",children:a.name}),e.jsx(y,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${a.id}`,value:"Bien",checked:((s=r.causas.find(n=>n.id===a.id))==null?void 0:s.state)==="Bien",onChange:()=>w(a.id,"Bien")})}),e.jsx(y,{className:"border-r border-l text-center",children:e.jsx("input",{type:"radio",name:`estado-${a.id}`,value:"Mal",checked:((i=r.causas.find(n=>n.id===a.id))==null?void 0:i.state)==="Mal",onChange:()=>w(a.id,"Mal")})}),e.jsx(y,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${a.id}`,value:"No Aplica",checked:((t=r.causas.find(n=>n.id===a.id))==null?void 0:t.state)==="No Aplica",onChange:()=>w(a.id,"No Aplica")})})]},a.id)})})]})})]}),e.jsxs("div",{className:"col-span-4",children:[e.jsx(m,{htmlFor:"observations",className:"mb-3",children:"Observaciones"}),e.jsx(W,{id:"observations",value:r.observations,onChange:a=>o(s=>({...s,observations:a.target.value})),placeholder:"Escriba sus observaciones aquí..."}),l.observations&&e.jsx("p",{className:"text-sm text-red-500",children:l.observations})]}),e.jsx("div",{className:"col-span-4",children:e.jsx(P,{images:r.images,onUpload:a=>{a.forEach(s=>{const i=new FileReader;i.onload=()=>{const t=i.result,n=new Image;n.src=t,n.onload=()=>{const c=document.createElement("canvas"),v=c.getContext("2d"),f=800,C=f/n.width;c.width=f,c.height=n.height*C,v==null||v.drawImage(n,0,0,c.width,c.height);const S=c.toDataURL("image/jpeg",.8);o(A=>({...A,images:[...A.images,S].slice(0,4)}))}},i.readAsDataURL(s)})},onRemove:a=>{const s=r.images.filter((i,t)=>t!==a);o(i=>({...i,images:s}))},label:"Imágenes adicionales"})}),e.jsx("div",{className:"col-span-4",children:e.jsx(P,{images:r.signature?[r.signature]:[],maxImages:1,onUpload:a=>{const s=new FileReader;s.onload=()=>{const i=s.result,t=new Image;t.src=i,t.onload=()=>{const n=document.createElement("canvas"),c=n.getContext("2d"),v=800,f=v/t.width;n.width=v,n.height=t.height*f,c==null||c.drawImage(t,0,0,n.width,n.height);const C=n.toDataURL("image/jpeg",.8);o(S=>({...S,signature:C}))}},s.readAsDataURL(a[0])},onRemove:()=>o(a=>({...a,signature:""})),label:"Firma"})}),e.jsx("div",{className:"col-span-4",children:e.jsx(B,{type:"submit",className:"flex-start",disabled:!L()||j,children:j?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):"Generar reporte"})})]})}const X=[{title:"Gestión de Formatos",href:"/format"},{title:"Inspección Vehicular Diaria",href:"/daily-vehicle-inspection"}];function ye(){const{causas:g,auth:p}=U().props,d=p.user.id,u=p.user.company_id,r=p.user.name,o=g.map(j=>({id:j.id,name:j.nombre}));return e.jsxs(J,{breadcrumbs:X,children:[e.jsx(M,{title:"Inspección Vehicular Diaria"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 rounded-xl p-4",children:e.jsx(Q,{causas:o,userId:d,userName:r,companyId:u})})]})}export{ye as default};
