import{m as K,r as j,j as e,U as Q}from"./app-D3C2KCvr.js";import{B as w}from"./button-XorcdaTA.js";import{I as h}from"./input-BrRKpmXb.js";import{L as c}from"./label-CM-Qq7xE.js";import{S as O,a as k,b as G,c as P,f as S}from"./select-FfDgl_4F.js";import{T as X,a as Y,b as v,c as p,d as ee,e as x}from"./table-BF3GUCWE.js";import{t as d}from"./index-B7drzVOH.js";import{I as U}from"./image-IdtLYotz.js";import{S as M}from"./search-B6U-T76n.js";const ae={camioneta:"Camioneta",combi:"Combi",ambulancia:"Ambulancia",bus:"Bus",camión:"Camión","camión grúa":"Camión grúa",otros:"Otros"};function me({causas:N,type:V,userId:$,companyId:H,userName:C,company:_}){const{data:s,setData:n,reset:z}=K({plate:"",type:"",brand:"",model:"",engineNumber:"",year:"",company:_,driver:"",licenseNumber:"",generalState:"",autoGeneratedCode:"",images:[],signature:"",result:"",inspectionDate:"",companyId:H,userId:$,userName:C,type_report:"vehicular",type_inspection:V}),[g,I]=j.useState(N.map(a=>({id:a.id,state:"",observation:""}))),[F,D]=j.useState(!1),[E,B]=j.useState(!1),[R,T]=j.useState(!1),A=()=>s.plate&&s.type&&s.brand&&s.model&&s.engineNumber&&s.year&&s.company&&s.driver&&s.licenseNumber&&s.generalState&&s.result&&s.inspectionDate,b=(a,r,t)=>{I(i=>i.map(l=>l.id===a?{...l,state:r,observation:t}:l))},W=()=>{if(!s.plate){d.error("Por favor, ingrese una placa para buscar.");return}D(!0),d.info("Buscando información para la placa...",{duration:3e3}),fetch(route("web.v1.searchVehicles",{plate:s.plate})).then(a=>{if(!a.ok)throw new Error("Error al buscar la placa.");return a.json()}).then(a=>{const r=a.data;r?(n("brand",r.brand||""),n("engineNumber",r.enginenumber||""),n("autoGeneratedCode",r.code||""),n("year",r.year||""),n("model",r.model||""),n("type",r.type||""),d.success("Información del vehículo cargada con éxito.")):d.error("No se encontró información para la placa ingresada.")}).catch(a=>{console.error(a),d.error("Ocurrió un error al buscar la placa.")}).finally(()=>{D(!1)})},q=()=>{if(!s.licenseNumber){d.error("Por favor, ingrese un número de licencia para buscar.");return}B(!0),d.info("Buscando información para el número de licencia...",{duration:3e3}),fetch(route("web.v1.searchUsers",{licenseNumber:s.licenseNumber})).then(a=>{if(!a.ok)throw new Error("Error al buscar el número de licencia.");return a.json()}).then(a=>{const r=a.data;r?(n("driver",`${r.nombres} ${r.apellidos}`),n("company",r.company||""),d.success("Información del usuario cargada con éxito.")):d.error("No se encontró información para el número de licencia ingresado.")}).catch(a=>{console.error(a),d.error("Ocurrió un error al buscar el número de licencia.")}).finally(()=>{B(!1)})},J=async a=>{if(a.preventDefault(),!A()){d.error("Por favor, complete todos los campos requeridos antes de enviar el formulario.");return}T(!0);try{const r=await fetch(route("web.v1.saveReport"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...s,causas:g})});if(r.ok){const t=await r.json();d.success(t.message||"Reporte guardado con éxito."),z(),I(N.map(i=>({id:i.id,state:"",observation:""})))}else if(r.status===422){const t=await r.json();d.error("Errores de validación en el formulario."),console.error(t.errors)}else throw new Error("Error al guardar el reporte.")}catch(r){console.error(r),d.error("Ocurrió un error al guardar el reporte. Intente de nuevo.")}finally{T(!1)}},Z=N.reduce((a,r)=>(a[r.group]||(a[r.group]=[]),a[r.group].push(r),a),{});return e.jsxs("form",{className:"grid gap-3 grid-cols-4",onSubmit:J,children:[e.jsxs("div",{className:"col-span-4",children:[e.jsx(c,{htmlFor:"company",className:"mb-3",children:"Empresa"}),e.jsx(h,{type:"text",id:"company",value:s.company||"",onChange:a=>n("company",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"type",className:"mb-3",children:"Tipo"}),e.jsxs(O,{onValueChange:a=>n("type",a),value:s.type,children:[e.jsx(k,{className:"w-full",children:e.jsx(G,{placeholder:"Seleccione un tipo"})}),e.jsx(P,{children:Object.entries(ae).map(([a,r])=>e.jsx(S,{value:a,children:r},a))})]})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"brand",className:"mb-3",children:"Marca"}),e.jsx(h,{type:"text",id:"brand",value:s.brand||"",onChange:a=>n("brand",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"model",className:"mb-3",children:"Modelo"}),e.jsx(h,{type:"text",id:"model",value:s.model||"",onChange:a=>n("model",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"engineNumber",className:"mb-3",children:"Nº Motor"}),e.jsx(h,{type:"text",id:"engineNumber",value:s.engineNumber||"",onChange:a=>n("engineNumber",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"year",className:"mb-3",children:"Año"}),e.jsx(h,{type:"text",id:"year",value:s.year||"",onChange:a=>n("year",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"plate",className:"mb-3",children:"Placa"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(h,{type:"text",id:"plate",value:s.plate||"",onChange:a=>n("plate",a.target.value),className:"flex-1"}),e.jsx(w,{variant:"outline",type:"button",onClick:W,className:"flex items-center px-2",disabled:F,children:F?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(M,{className:"h-5 w-5 text-gray-500"})})]})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"driver",className:"mb-3",children:"Conductor"}),e.jsx(h,{type:"text",id:"driver",value:s.driver||"",onChange:a=>n("driver",a.target.value)})]}),e.jsx("div",{className:"",children:e.jsxs("div",{className:"flex-1",children:[e.jsx(c,{htmlFor:"licenseNumber",className:"mb-3",children:"Nº Licencia"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(h,{type:"text",id:"licenseNumber",value:s.licenseNumber||"",onChange:a=>n("licenseNumber",a.target.value),className:"flex-1"}),e.jsx(w,{variant:"outline",type:"button",onClick:q,className:"flex items-center px-2",disabled:E,children:E?e.jsx("span",{className:"loader h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}):e.jsx(M,{className:"h-5 w-5 text-gray-500"})})]})]})}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"generalState",className:"mb-3",children:"Estado General del Vehículo"}),e.jsx(h,{type:"text",id:"generalState",value:s.generalState||"",onChange:a=>n("generalState",a.target.value)})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"autoGeneratedCode",className:"mb-3",children:"Código Autogenerado"}),e.jsx(h,{type:"text",id:"autoGeneratedCode",value:s.autoGeneratedCode||"",disabled:!0})]}),e.jsxs("div",{className:"col-span-full  ",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:"Causas"}),e.jsx("div",{className:"bg-background overflow-hidden rounded-md border",children:e.jsxs(X,{children:[e.jsxs(Y,{children:[e.jsxs(v,{className:"bg-muted/50 border-b",children:[e.jsx(p,{className:"h-8 border-r py-2",rowSpan:2,style:{width:"50%"},children:"Item"}),e.jsx(p,{className:"h-8 border-r py-2",colSpan:3,children:"Estado"}),e.jsx(p,{className:"h-8 border-l py-2",rowSpan:2,style:{width:"20%"},children:"Observaciones"})]}),e.jsxs(v,{className:"bg-muted/50 border-b",children:[e.jsx(p,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Bien"}),e.jsx(p,{className:"h-8 border-r py-2",style:{width:"10%"},children:"Mal"}),e.jsx(p,{className:"h-8 py-2",style:{width:"10%"},children:"No Aplica"})]})]}),e.jsx(ee,{children:Object.entries(Z).map(([a,r])=>e.jsxs(Q.Fragment,{children:[e.jsx(v,{className:"bg-muted/50",children:e.jsx(x,{colSpan:5,className:"text-center font-bold",children:a})}),r.map(t=>{var i,l,m,u;return e.jsxs(v,{children:[e.jsx(x,{className:"border-r py-1 font-medium whitespace-normal",children:t.name}),e.jsx(x,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"Bien",checked:((i=g.find(o=>o.id===t.id))==null?void 0:i.state)==="Bien",onChange:()=>b(t.id,"Bien","")})}),e.jsx(x,{className:"border-r border-l text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"Mal",checked:((l=g.find(o=>o.id===t.id))==null?void 0:l.state)==="Mal",onChange:()=>b(t.id,"Mal","")})}),e.jsx(x,{className:"text-center",children:e.jsx("input",{type:"radio",name:`estado-${t.id}`,value:"No Aplica",checked:((m=g.find(o=>o.id===t.id))==null?void 0:m.state)==="No Aplica",onChange:()=>b(t.id,"No Aplica","")})}),e.jsx(x,{children:e.jsx(h,{type:"text",value:((u=g.find(o=>o.id===t.id))==null?void 0:u.observation)||"",onChange:o=>b(t.id,"",o.target.value)})})]},t.id)})]},a))})]})})]}),e.jsx("div",{className:"",children:e.jsx(U,{images:s.images,onUpload:a=>{a.forEach(r=>{const t=new FileReader;t.onload=()=>{const i=t.result,l=new Image;l.src=i,l.onload=()=>{const m=document.createElement("canvas"),u=m.getContext("2d"),o=800,f=o/l.width;m.width=o,m.height=l.height*f,u==null||u.drawImage(l,0,0,m.width,m.height);const y=m.toDataURL("image/jpeg",.8);n(L=>({...L,images:[...L.images,y].slice(0,4)}))}},t.readAsDataURL(r)})},onRemove:a=>{const r=s.images.filter((t,i)=>i!==a);n(t=>({...t,images:r}))},label:"Imágenes adicionales"})}),e.jsx("div",{className:"",children:e.jsx(U,{images:s.signature?[s.signature]:[],maxImages:1,onUpload:a=>{const r=new FileReader;r.onload=()=>{const t=r.result,i=new Image;i.src=t,i.onload=()=>{const l=document.createElement("canvas"),m=l.getContext("2d"),u=800,o=u/i.width;l.width=u,l.height=i.height*o,m==null||m.drawImage(i,0,0,l.width,l.height);const f=l.toDataURL("image/jpeg",.8);n(y=>({...y,signature:f}))}},r.readAsDataURL(a[0])},onRemove:()=>n(a=>({...a,signature:""})),label:"Firma"})}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"result",className:"mb-3",children:"Resultado"}),e.jsxs(O,{onValueChange:a=>n("result",a),value:s.result,children:[e.jsx(k,{className:"w-full",children:e.jsx(G,{placeholder:"Seleccione el resultado"})}),e.jsxs(P,{children:[e.jsx(S,{value:"Aprobado",children:"Aprobado"}),e.jsx(S,{value:"Desaprobado",children:"Desaprobado"})]})]})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"inspectedBy",className:"mb-3",children:"Inspeccionado por"}),e.jsx(h,{type:"text",id:"inspectedBy",value:C,disabled:!0})]}),e.jsxs("div",{className:"",children:[e.jsx(c,{htmlFor:"inspectionDate",className:"mb-3",children:"Fecha y Hora de Inspección"}),e.jsx(h,{type:"datetime-local",id:"inspectionDate",value:s.inspectionDate||"",onChange:a=>n("inspectionDate",a.target.value)})]}),e.jsx("div",{className:"",children:e.jsx(w,{type:"submit",className:"flex items-center",disabled:!A()||R,children:R?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loader mr-2 h-5 w-5 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"}),"Generando reporte..."]}):"Generar reporte"})})]})}export{me as I};
